import{a as at,b as Bn,c as On}from"./chunk-YQ4C6CO3.js";import{a as En,b as Pn,c as In}from"./chunk-ATB45EAC.js";import{a as He,c as je,d as Ge,h as Zt,i as qe}from"./chunk-ZA34VCLS.js";import{$ as w,Ba as _t,Fa as Le,Ja as tt,Ta as Ae,Wa as Re,jb as We,vb as $e,wa as Xt,yb as Ue}from"./chunk-I2RAQBWN.js";import"./chunk-AF73PXIT.js";import"./chunk-LRIKAP6Q.js";import{a as Mn,b as Nn}from"./chunk-SIIEBSAT.js";import{a as mn,b as un,c as kt}from"./chunk-J6PITLOE.js";import{d as Ie,f as Be,i as Ve,j as xt,k as Tt}from"./chunk-IEIGPFXF.js";import{a as xn,b as Tn,c as Dn,d as Fn,e as kn}from"./chunk-Y5XW6TKY.js";import{a as vn,b as wn}from"./chunk-GFRFZT36.js";import"./chunk-XY7ZTW3N.js";import{f as ot,k as rt}from"./chunk-2QP5ASAP.js";import"./chunk-YJLPXUZH.js";import{c as dn,d as fn,f as gn,h as Cn,j as _n,k as zn,l as hn,n as yn}from"./chunk-P65TELVZ.js";import"./chunk-7Y7RPWKD.js";import{a as rn,c as an,f as sn,g as cn,i as ln,j as pn}from"./chunk-4YTDYDIC.js";import"./chunk-L7MYJ753.js";import{a as nn,b as on}from"./chunk-NB2WFYBW.js";import"./chunk-2SMWRKZV.js";import{a as bn,b as Sn}from"./chunk-CQZDDL6X.js";import{d as et}from"./chunk-2WTG2XMQ.js";import"./chunk-OBGYZQEU.js";import"./chunk-AW7N2FUZ.js";import"./chunk-SVONCNS6.js";import"./chunk-VKW3WH5F.js";import{d as nt,e as Jt,g as it,h as Ye,m as Dt,n as Xe,o as Ze,q as Je,t as Ke,x as tn,y as Ft,z as en}from"./chunk-75AQQ352.js";import"./chunk-BB66XR64.js";import"./chunk-2M5CHBKO.js";import"./chunk-AHBW3B6E.js";import{t as Yt}from"./chunk-23I64B73.js";import"./chunk-PCDTQVOY.js";import{d as Qe}from"./chunk-OW7234XQ.js";import"./chunk-OG6J75NL.js";import"./chunk-QJMKMVSR.js";import"./chunk-ZYDPBZFO.js";import"./chunk-QESUVVYF.js";import{h as $,q as U,s as H,t as j}from"./chunk-3RRHG5WX.js";import{Jc as N,Kc as E,Lc as Oe,Y as Qt,a as Me,aa as Ee,b as Ne,ca as Pe,k as St}from"./chunk-LRVALGQA.js";import"./chunk-LBUPYOOJ.js";import{a as bt}from"./chunk-YIOOD6AO.js";import{A as K,q as vt,r as wt,s as qt,z as ke}from"./chunk-7CV657US.js";import{$b as k,Ac as ze,Ba as u,Bc as he,Ca as d,Dc as A,Ec as R,Ed as jt,Fc as W,Ga as pe,Gb as x,Gc as Ut,Ha as Wt,Hb as de,Ic as ye,Id as Gt,Jc as I,La as y,Lc as dt,Mb as S,Nc as ve,Oc as m,Pb as P,Pc as q,Qb as fe,Qc as T,R as se,Sa as me,Tc as ft,Uc as gt,Vc as Ct,b as oe,bc as M,cd as we,dc as ge,ec as ht,ed as be,fc as yt,g as re,gc as l,ha as ce,hc as a,hd as Se,ic as s,jc as _,kd as xe,ld as B,nc as Ce,ob as ue,oc as _e,pa as zt,pc as $t,q as ae,qa as le,qc as v,qd as O,r as At,rd as Te,sd as De,ta as Rt,tb as c,ua as h,vd as Fe,wc as f,wd as V,zb as G,zc as p,zd as Ht}from"./chunk-ARNVYSUA.js";import{a as F,b as L,g as Lt,i as z}from"./chunk-57BLH6QZ.js";function jn(o,e){}function Gn(o,e){if(o&1&&(a(0,"div",2),S(1,jn,0,0,"ng-template",4),s()),o&2){let t=p(2);c(),l("ngTemplateOutlet",t.nzIcon)}}function qn(o,e){if(o&1&&(Ce(0),m(1),_e()),o&2){let t=p(3);c(),T(" ",t.nzDescription," ")}}function Qn(o,e){if(o&1&&(a(0,"div",3),S(1,qn,2,1,"ng-container",5),s()),o&2){let t=p(2);c(),l("nzStringTemplateOutlet",t.nzDescription)}}function Yn(o,e){if(o&1&&(k(0,Gn,2,1,"div",2),k(1,Qn,2,1,"div",3)),o&2){let t=p();M(t.nzIcon?0:-1),c(),M(t.nzDescription&&t.nzShape==="square"?1:-1)}}function Xn(o,e){o&1&&(a(0,"div",2),_(1,"nz-icon",6),s())}function Zn(o,e){if(o&1){let t=v();a(0,"a",2),f("click",function(){u(t);let i=p();return d(i.nzOnClick.emit(!0))}),_(1,"nz-float-button-content",3),s()}if(o&2){let t=p();dt("ant-float-btn-default",t.nzType==="default"),l("target",t.nzTarget)("href",t.nzHref,ue)("nzType",t.nzType),c(),l("nzIcon",t.nzIcon)("nzDescription",t.nzDescription)("nzShape",t.nzShape)}}function Jn(o,e){if(o&1){let t=v();a(0,"button",4),f("click",function(){u(t);let i=p();return d(i.nzOnClick.emit(!0))}),_(1,"nz-float-button-content",3),s()}if(o&2){let t=p();dt("ant-float-btn-default",t.nzType==="default"),l("nzType",t.nzType),c(),l("nzIcon",t.nzIcon)("nzDescription",t.nzDescription)("nzShape",t.nzShape)}}var Kn=["backTop"];function ti(o,e){o&1&&_(0,"nz-icon",3)}var ei=["*"];function ni(o,e){o&1&&$t(0)}function ii(o,e){if(o&1&&S(0,ni,1,0,"ng-container",2),o&2){p();let t=I(3);l("ngTemplateOutlet",t)}}function oi(o,e){o&1&&$t(0)}function ri(o,e){if(o&1&&(a(0,"div",3),S(1,oi,1,0,"ng-container",2),s()),o&2){p(2);let t=I(3);l("@fadeMotion",void 0),c(),l("ngTemplateOutlet",t)}}function ai(o,e){if(o&1){let t=v();k(0,ri,2,2,"div",3),a(1,"nz-float-button",4),f("nzOnClick",function(){u(t);let i=p();return d(i.open()?i.clickCloseMenu():i.clickOpenMenu())})("mouseover",function(){u(t);let i=p();return d(i.hoverOpenMenu())}),s()}if(o&2){let t=p(),n=I(5);M(t.open()?0:-1),c(),l("nzType",t.nzType())("nzIcon",t.open()?n:t.nzIcon())("nzShape",t.nzShape())("nzDescription",t.open()?null:t.nzDescription())}}function si(o,e){o&1&&he(0)}function ci(o,e){o&1&&_(0,"nz-icon",5)}var Vn=(()=>{class o{nzIcon=null;nzDescription=null;nzShape="circle";static \u0275fac=function(n){return new(n||o)};static \u0275cmp=x({type:o,selectors:[["nz-float-button-content"]],inputs:{nzIcon:"nzIcon",nzDescription:"nzDescription",nzShape:"nzShape"},exportAs:["nzFloatButtonContent"],decls:4,vars:1,consts:[[1,"ant-float-btn-body"],[1,"ant-float-btn-content"],[1,"ant-float-btn-icon"],[1,"ant-float-btn-description"],[3,"ngTemplateOutlet"],[4,"nzStringTemplateOutlet"],["nzType","file-text","nzTheme","outline"]],template:function(n,i){n&1&&(a(0,"div",0)(1,"div",1),k(2,Yn,2,2)(3,Xn,2,0,"div",2),s()()),n&2&&(c(2),M(i.nzDescription||i.nzIcon?2:3))},dependencies:[E,N,qt,Oe],encapsulation:2,changeDetection:0})}return o})(),Q=(()=>{class o{directionality=h(St);cdr=h(jt);destroyRef=h(Wt);nzHref=null;nzTarget=null;nzType="default";nzShape="circle";nzIcon=null;nzDescription=null;nzOnClick=new P;dir="ltr";constructor(){this.dir=this.directionality.value}ngOnInit(){this.directionality.change?.pipe(bt(this.destroyRef)).subscribe(t=>{this.dir=t,this.cdr.detectChanges()}),this.dir=this.directionality.value}static \u0275fac=function(n){return new(n||o)};static \u0275cmp=x({type:o,selectors:[["nz-float-button"]],hostAttrs:[1,"ant-float-btn"],hostVars:6,hostBindings:function(n,i){n&2&&dt("ant-float-btn-circle",i.nzShape==="circle")("ant-float-btn-square",i.nzShape==="square")("ant-float-btn-rtl",i.dir==="rtl")},inputs:{nzHref:"nzHref",nzTarget:"nzTarget",nzType:"nzType",nzShape:"nzShape",nzIcon:"nzIcon",nzDescription:"nzDescription"},outputs:{nzOnClick:"nzOnClick"},exportAs:["nzFloatButton"],decls:2,vars:1,consts:[["nz-button","",1,"ant-float-btn-inner",3,"target","href","nzType","ant-float-btn-default"],["nz-button","",1,"ant-float-btn-inner",3,"nzType","ant-float-btn-default"],["nz-button","",1,"ant-float-btn-inner",3,"click","target","href","nzType"],[3,"nzIcon","nzDescription","nzShape"],["nz-button","",1,"ant-float-btn-inner",3,"click","nzType"]],template:function(n,i){n&1&&k(0,Zn,2,8,"a",0)(1,Jn,2,6,"button",1),n&2&&M(i.nzHref?0:1)},dependencies:[j,H,$,U,Vn],encapsulation:2,changeDetection:0})}return o})(),li="backTop",pi=Ne({passive:!0}),Kt=(()=>{var n;let o,e=[],t=[];return n=class{nzConfigService=h(Ee);scrollSrv=h(Qe);platform=h(Me);ngZone=h(fe);cdr=h(jt);directionality=h(St);destroyRef=h(Wt);_nzModuleName=li;scrollListenerDestroy$=new re;target=null;visible=!1;dir="ltr";nzHref=null;nzType="default";nzShape="circle";nzIcon=null;nzDescription=null;nzTemplate;nzVisibilityHeight=At(this,e,400);nzTarget=At(this,t);nzDuration=450;nzOnClick=new P;set backTop(r){r&&(this.backTopClickSubscription.unsubscribe(),this.backTopClickSubscription=Qt(r.nativeElement,"click").pipe(bt(this.destroyRef)).subscribe(()=>{this.scrollSrv.scrollTo(this.getTarget(),0,{duration:this.nzDuration}),this.nzOnClick.observers.length&&this.ngZone.run(()=>this.nzOnClick.emit(!0))}))}doc=h(pe);backTopClickSubscription=oe.EMPTY;constructor(){this.destroyRef.onDestroy(()=>{this.scrollListenerDestroy$.next(),this.scrollListenerDestroy$.complete()})}ngOnInit(){this.registerScrollEvent(),this.dir=this.directionality.value,this.directionality.change?.pipe(bt(this.destroyRef)).subscribe(r=>{this.dir=r,this.cdr.detectChanges()})}getTarget(){return this.target||window}handleScroll(){this.visible!==this.scrollSrv.getScroll(this.getTarget())>this.nzVisibilityHeight&&(this.visible=!this.visible,this.cdr.detectChanges())}registerScrollEvent(){this.platform.isBrowser&&(this.scrollListenerDestroy$.next(),this.handleScroll(),Qt(this.getTarget(),"scroll",pi).pipe(se(50),ce(this.scrollListenerDestroy$)).subscribe(()=>this.handleScroll()))}detectChanges(){this.cdr.detectChanges()}ngOnChanges(r){let{nzTarget:g}=r;g&&(this.target=typeof this.nzTarget=="string"?this.doc.querySelector(this.nzTarget):this.nzTarget,this.registerScrollEvent())}},(()=>{let r=typeof Symbol=="function"&&Symbol.metadata?Object.create(null):void 0;o=[Pe()],ae(null,null,o,{kind:"field",name:"nzVisibilityHeight",static:!1,private:!1,access:{has:g=>"nzVisibilityHeight"in g,get:g=>g.nzVisibilityHeight,set:(g,C)=>{g.nzVisibilityHeight=C}},metadata:r},e,t),r&&Object.defineProperty(n,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:r})})(),Lt(n,"\u0275fac",function(g){return new(g||n)}),Lt(n,"\u0275cmp",x({type:n,selectors:[["nz-float-button-top"]],viewQuery:function(g,C){if(g&1&&A(Kn,5),g&2){let D;R(D=W())&&(C.backTop=D.first)}},hostAttrs:[1,"ant-float-btn","ant-float-btn-top"],hostVars:8,hostBindings:function(g,C){g&2&&dt("ant-float-btn-circle",C.nzShape==="circle")("ant-float-btn-hidden",!C.visible)("ant-float-btn-square",C.nzShape==="square")("ant-float-btn-rtl",C.dir==="rtl")},inputs:{nzHref:"nzHref",nzType:"nzType",nzShape:"nzShape",nzIcon:"nzIcon",nzDescription:"nzDescription",nzTemplate:"nzTemplate",nzVisibilityHeight:[2,"nzVisibilityHeight","nzVisibilityHeight",Gt],nzTarget:"nzTarget",nzDuration:[2,"nzDuration","nzDuration",Gt]},outputs:{nzOnClick:"nzOnClick"},exportAs:["nzFloatButtonTop"],features:[me],decls:5,vars:6,consts:[["backTop",""],["top",""],[3,"nzIcon","nzDescription","nzHref","nzType","nzShape"],["nzType","vertical-align-top","nzTheme","outline"]],template:function(g,C){if(g&1&&(a(0,"div",null,0),_(2,"nz-float-button",2),S(3,ti,1,0,"ng-template",null,1,B),s()),g&2){let D=I(4);l("@fadeMotion",void 0),c(2),l("nzIcon",C.nzIcon||D)("nzDescription",C.nzDescription)("nzHref",C.nzHref)("nzType",C.nzType)("nzShape",C.nzShape)}},dependencies:[Q,E,N],encapsulation:2,data:{animation:[Yt]},changeDetection:0})),n})(),ie=(()=>{class o{nzFloatButtonComponents=Ht(Q);nzFloatButtonTopComponents=Ht(Kt);nzHref=V(null);nzTarget=V(null);nzType=V("default");nzIcon=V(null);nzDescription=V(null);nzShape=V("circle");nzTrigger=V(null);nzOpen=V(null);nzPlacement=V("top");nzOnOpenChange=Fe();dir=h(St).valueSignal;open=De(()=>!!this.nzOpen());isMenuMode=O(()=>!!this.nzTrigger()&&["click","hover"].includes(this.nzTrigger()));isControlledMode=O(()=>this.nzOpen()!==null);class=O(()=>{let t=this.nzShape(),n=this.dir(),i=["ant-float-btn-group",this.generateClass(t)];return this.isMenuMode()?i.push(this.generateClass(this.nzPlacement())):i.push(this.generateClass(`${t}-shadow`)),n==="rtl"&&i.push(this.generateClass(n)),i});constructor(){Te(()=>{this.nzFloatButtonComponents()&&this.nzFloatButtonComponents().forEach(t=>{t.nzShape=this.nzShape()}),this.nzFloatButtonTopComponents()&&this.nzFloatButtonTopComponents().forEach(t=>{t.nzShape=this.nzShape(),t.detectChanges()})})}clickOpenMenu(){this.handleEvent("click",!0)}hoverOpenMenu(){this.handleEvent("hover",!0)}clickCloseMenu(){this.handleEvent("click",!1)}hoverCloseMenu(){this.handleEvent("hover",!1)}handleEvent(t,n){this.nzTrigger()!==t||this.isControlledMode()||this.open()===n||(this.open.set(n),this.nzOnOpenChange.emit(n))}generateClass(t){return`ant-float-btn-group-${t}`}static \u0275fac=function(n){return new(n||o)};static \u0275cmp=x({type:o,selectors:[["nz-float-button-group"]],contentQueries:function(n,i,r){n&1&&(Ut(r,i.nzFloatButtonComponents,Q,4),Ut(r,i.nzFloatButtonTopComponents,Kt,4)),n&2&&ye(2)},hostVars:2,hostBindings:function(n,i){n&1&&f("mouseleave",function(){return i.hoverCloseMenu()}),n&2&&ve(i.class())},inputs:{nzHref:[1,"nzHref"],nzTarget:[1,"nzTarget"],nzType:[1,"nzType"],nzIcon:[1,"nzIcon"],nzDescription:[1,"nzDescription"],nzShape:[1,"nzShape"],nzTrigger:[1,"nzTrigger"],nzOpen:[1,"nzOpen"],nzPlacement:[1,"nzPlacement"]},outputs:{nzOnOpenChange:"nzOnOpenChange"},exportAs:["nzFloatButtonGroup"],ngContentSelectors:ei,decls:6,vars:1,consts:[["menu",""],["close",""],[4,"ngTemplateOutlet"],[1,"ant-float-btn-group-wrap"],[1,"ant-float-btn-group-trigger",3,"nzOnClick","mouseover","nzType","nzIcon","nzShape","nzDescription"],["nzType","close","nzTheme","outline"]],template:function(n,i){n&1&&(ze(),k(0,ii,1,1,"ng-container")(1,ai,2,5),S(2,si,1,0,"ng-template",null,0,B)(4,ci,1,0,"ng-template",null,1,B)),n&2&&M(i.isMenuMode()?1:0)},dependencies:[Q,E,N,qt],encapsulation:2,data:{animation:[Yt]},changeDetection:0})}return o})(),Ln=(()=>{class o{static \u0275fac=function(n){return new(n||o)};static \u0275mod=de({type:o});static \u0275inj=le({imports:[Q,ie,Kt,Vn]})}return o})();var ui=["upIcon"],di=["downIcon"],fi=["leftIcon"],gi=["rightIcon"],Ci=["commentIcon"],_i=(o,e)=>({x:o,y:e});function zi(o,e){o&1&&_(0,"nz-icon",8)}function hi(o,e){o&1&&_(0,"nz-icon",9)}function yi(o,e){o&1&&_(0,"nz-icon",10)}function vi(o,e){o&1&&_(0,"nz-icon",11)}function wi(o,e){o&1&&_(0,"nz-icon",12)}var st=class st{constructor(){this.dragX=0;this.dragY=0;this.smartPlacement="top";this.currentX=0;this.currentY=0;this.onAction=new P}get currentIcon(){return{top:this.upIcon,bottom:this.downIcon,left:this.leftIcon,right:this.rightIcon}[this.smartPlacement]}onDragMove(e){let t=e.source.element.nativeElement.getBoundingClientRect();this.currentX=t.left,this.currentY=t.top,this.smartPlacement=this.calculateSmartPlacement(this.currentX,this.currentY)}onDragEnd(e){this.dragX=e.source.getFreeDragPosition().x,this.dragY=e.source.getFreeDragPosition().y,this.smartPlacement=this.calculateSmartPlacement(this.currentX,this.currentY)}calculateSmartPlacement(e,t){let n=window.innerWidth,i=window.innerHeight,r=56,g=e+r/2,C=t+r/2,D=n/2,Vt=i/2,b=g-D,J=C-Vt;return Math.abs(b)>Math.abs(J)?b>0?"left":"right":J>0?"top":"bottom"}openChange(e){}};st.\u0275fac=function(t){return new(t||st)},st.\u0275cmp=x({type:st,selectors:[["app-fab"]],viewQuery:function(t,n){if(t&1&&(A(ui,7),A(di,7),A(fi,7),A(gi,7),A(Ci,7)),t&2){let i;R(i=W())&&(n.upIcon=i.first),R(i=W())&&(n.downIcon=i.first),R(i=W())&&(n.leftIcon=i.first),R(i=W())&&(n.rightIcon=i.first),R(i=W())&&(n.commentIcon=i.first)}},outputs:{onAction:"onAction"},decls:13,vars:7,consts:[["upIcon",""],["downIcon",""],["leftIcon",""],["rightIcon",""],["commentIcon",""],["cdkDrag","",1,"fab-drag-anchor",3,"cdkDragEnded","cdkDragMoved","cdkDragFreeDragPosition"],["nzType","primary","nzTrigger","click",3,"nzOnOpenChange","nzIcon","nzPlacement"],[3,"click","nzIcon"],["nzType","up","nzTheme","outline"],["nzType","down","nzTheme","outline"],["nzType","left","nzTheme","outline"],["nzType","right","nzTheme","outline"],["nzType","plus","nzTheme","outline"]],template:function(t,n){if(t&1){let i=v();a(0,"div",5),f("cdkDragEnded",function(g){return u(i),d(n.onDragEnd(g))})("cdkDragMoved",function(g){return u(i),d(n.onDragMove(g))}),a(1,"nz-float-button-group",6),f("nzOnOpenChange",function(g){return u(i),d(n.openChange(g))}),a(2,"nz-float-button",7),f("click",function(){return u(i),d(n.onAction.emit("add"))}),s()(),S(3,zi,1,0,"ng-template",null,0,B)(5,hi,1,0,"ng-template",null,1,B)(7,yi,1,0,"ng-template",null,2,B)(9,vi,1,0,"ng-template",null,3,B)(11,wi,1,0,"ng-template",null,4,B),s()}if(t&2){let i=I(12);l("cdkDragFreeDragPosition",be(4,_i,n.dragX,n.dragY)),c(),l("nzIcon",n.currentIcon)("nzPlacement",n.smartPlacement),c(),l("nzIcon",i)}},dependencies:[Ln,Q,ie,E,N,Be,Ie],styles:[".fab-drag-anchor[_ngcontent-%COMP%]{position:fixed;z-index:1000;right:32px;bottom:32px;cursor:grab;-webkit-user-select:none;user-select:none}.fab-drag-anchor[_ngcontent-%COMP%]:active{cursor:grabbing}nz-float-button-group[_ngcontent-%COMP%]{position:absolute}"]});var Nt=st;var X=class X{constructor(e,t){this.hubCrud=e;this.workflowService=t;this.collectionName="hub_contract_payments"}listByContract(e){return z(this,null,function*(){let t=_t(this.hubCrud.firestoreInstance,this.collectionName),n=We(t,Ue("contractId","==",e));return(yield Re(n)).docs.map(r=>F({key:r.id},r.data()))})}add(e,t,n="",i){return z(this,null,function*(){let r=yield this.workflowService.getTemplateForClient(i);if(!r){console.warn(`No workflow template found for client: ${i}, creating default template`);let b=yield this.createDefaultWorkflowTemplate(i),J=yield this.workflowService.getTemplateForClient(i);if(!J)throw new Error(`Failed to create default workflow template for client: ${i}`);let $n=yield this.initializeWorkflow(J.key),Un={contractId:e,amount:t,status:"draft",workflowId:J.key,steps:$n,attachments:[],remark:n,createdAt:w(),updatedAt:w()},Hn=_t(this.hubCrud.firestoreInstance,this.collectionName);return(yield Xt(Hn,Un)).id}let g=yield this.initializeWorkflow(r.key),C={contractId:e,amount:t,status:"draft",workflowId:r.key,steps:g,attachments:[],remark:n,createdAt:w(),updatedAt:w()},D=_t(this.hubCrud.firestoreInstance,this.collectionName);return(yield Xt(D,C)).id})}update(e,t){return z(this,null,function*(){let n=L(F({},t),{updatedAt:w()}),i=tt(this.hubCrud.firestoreInstance,this.collectionName,e);yield $e(i,n)})}delete(e){return z(this,null,function*(){let t=tt(this.hubCrud.firestoreInstance,this.collectionName,e);yield Le(t)})}submitPayment(e){return z(this,null,function*(){let t=tt(this.hubCrud.firestoreInstance,this.collectionName,e),{runTransaction:n}=yield import("./chunk-JBQAHJAT.js");yield n(this.hubCrud.firestoreInstance,i=>z(this,null,function*(){let r=yield i.get(t);if(!r.exists())throw new Error(`Payment not found: ${e}`);let g=F({key:r.id},r.data());if(g.status!=="draft")throw new Error(`Payment cannot be submitted. Current status: ${g.status}`);let C=[...g.steps];C.length>0&&(C[0]=L(F({},C[0]),{status:"pending",updatedAt:w()})),i.update(t,{status:"submitted",steps:C,updatedAt:w()})}))})}initializeWorkflow(e){return z(this,null,function*(){let t=_t(this.hubCrud.firestoreInstance,"hub_workflow_definitions"),n=tt(t,e),i=yield Ae(n);if(!i.exists())throw new Error(`Workflow template not found: ${e}`);return F({key:i.id},i.data()).steps.map((g,C)=>({name:g.name,status:"waiting",approver:g.approver,comment:"",updatedAt:w()}))})}advanceWorkflow(e,t,n,i=""){return z(this,null,function*(){let r=tt(this.hubCrud.firestoreInstance,this.collectionName,e),{runTransaction:g}=yield import("./chunk-JBQAHJAT.js");yield g(this.hubCrud.firestoreInstance,C=>z(this,null,function*(){let D=yield C.get(r);if(!D.exists())throw new Error(`Payment not found: ${e}`);let b=[...F({key:D.id},D.data()).steps];if(t<0||t>=b.length)throw new Error(`Invalid step index: ${t}`);if(b[t].status!=="pending")throw new Error(`Step ${t} is not in pending status`);n?(b[t]=L(F({},b[t]),{status:"done",comment:i,updatedAt:w()}),t+1<b.length?(b[t+1]=L(F({},b[t+1]),{status:"pending",updatedAt:w()}),C.update(r,{steps:b,status:"reviewing",updatedAt:w()})):C.update(r,{steps:b,status:"approved",updatedAt:w()})):(b[t]=L(F({},b[t]),{status:"rejected",comment:i,updatedAt:w()}),C.update(r,{steps:b,status:"rejected",updatedAt:w()}))}))})}createDefaultWorkflowTemplate(e){return z(this,null,function*(){let t={name:`${e} \u9810\u8A2D\u5BE9\u6279\u6D41\u7A0B`,clientId:e,isActive:!0,steps:[{name:"\u4E3B\u7BA1\u5BE9\u6838",approver:"supervisor",order:1},{name:"\u8CA1\u52D9\u5BE9\u6838",approver:"finance",order:2}],createdAt:w(),updatedAt:w()};return yield this.workflowService.createTemplate(t)})}};X.\u0275fac=function(t){return new(t||X)(Rt(at),Rt(Bn))},X.\u0275prov=zt({token:X,factory:X.\u0275fac,providedIn:"root"});var ct=X;function Di(o,e){if(o&1&&_(0,"nz-step",8),o&2){let t=e.$implicit,n=p();l("nzTitle",t.name)("nzDescription",n.getStepDescription(t))("nzIcon",n.getStepIcon(t.status))}}function Fi(o,e){if(o&1){let t=v();a(0,"div",9)(1,"button",10),f("click",function(){u(t);let i=p();return d(i.showApprovalModal(!0))}),_(2,"span",11),m(3," \u6838\u51C6 "),s(),a(4,"button",12),f("click",function(){u(t);let i=p();return d(i.showApprovalModal(!1))}),_(5,"span",13),m(6," \u62D2\u7D55 "),s()()}if(o&2){let t=p();c(),l("nzLoading",t.isProcessing()),c(3),l("nzLoading",t.isProcessing())}}function ki(o,e){if(o&1&&(a(0,"div",14)(1,"span",15),_(2,"span",16),m(3),s()()),o&2){let t,n=p();c(3),T(" \u7B49\u5F85 ",(t=n.getCurrentStep())==null?null:t.approver," \u5BE9\u6279 ")}}var lt=class lt{constructor(){this.currentUser="current-user";this.workflowUpdated=new P;this.paymentService=h(ct);this.hubCrud=h(at);this.message=h(et);this.isProcessing=y(!1);this.showModal=y(!1);this.isApproving=y(!1);this.approvalComment=y("");this.currentStepIndex=O(()=>{let e=this.payment.steps.findIndex(t=>t.status==="pending");return e>=0?e:this.payment.steps.length});this.modalTitle=O(()=>this.isApproving()?"\u78BA\u8A8D\u6838\u51C6":"\u78BA\u8A8D\u62D2\u7D55");this.modalMessage=O(()=>{let e=this.getCurrentStep();return`\u78BA\u5B9A\u8981${this.isApproving()?"\u6838\u51C6":"\u62D2\u7D55"}\u300C${e?.name}\u300D\u6B65\u9A5F\u55CE\uFF1F`})}getCurrentStep(){let e=this.currentStepIndex();return e<this.payment.steps.length?this.payment.steps[e]:null}canCurrentUserApprove(){let e=this.getCurrentStep();return e?.status==="pending"&&e?.approver===this.currentUser}getStepsStatus(){return this.payment.status==="approved"?"finish":this.payment.status==="rejected"?"error":"process"}getStepIcon(e){switch(e){case"done":return"check";case"rejected":return"close";case"pending":return"clock-circle";case"waiting":return"ellipsis";default:return"ellipsis"}}getStepDescription(e){switch(e.status){case"done":return e.comment||"\u5DF2\u6838\u51C6";case"rejected":return e.comment||"\u5DF2\u62D2\u7D55";case"pending":return"\u5F85\u5BE9\u6279";case"waiting":return"\u7B49\u5F85\u4E2D";default:return""}}showApprovalModal(e){this.isApproving.set(e),this.approvalComment.set(""),this.showModal.set(!0)}closeModal(){this.showModal.set(!1),this.approvalComment.set("")}onModalVisibleChange(e){this.showModal.set(e),e||this.approvalComment.set("")}handleApproval(){return z(this,null,function*(){if(!this.isProcessing()){this.isProcessing.set(!0);try{let e=this.currentStepIndex(),t=this.isApproving(),n=this.approvalComment();if(e<0||e>=this.payment.steps.length)throw new Error("Invalid workflow step");yield this.paymentService.advanceWorkflow(this.payment.key,e,t,n);let i=t?"\u6838\u51C6":"\u62D2\u7D55";this.message.success(`${i}\u6210\u529F`),this.closeModal(),this.workflowUpdated.emit()}catch(e){console.error("Workflow approval error:",e);let t=e instanceof Error?e.message:"\u64CD\u4F5C\u5931\u6557\uFF0C\u8ACB\u91CD\u8A66";this.message.error(t)}finally{this.isProcessing.set(!1)}}})}};lt.\u0275fac=function(t){return new(t||lt)},lt.\u0275cmp=x({type:lt,selectors:[["app-contract-workflow-steps"]],inputs:{payment:"payment",currentUser:"currentUser"},outputs:{workflowUpdated:"workflowUpdated"},decls:14,vars:12,consts:[[1,"workflow-steps-container"],["nzSize","small",3,"nzCurrent","nzStatus"],[3,"nzTitle","nzDescription","nzIcon",4,"ngFor","ngForOf"],[1,"workflow-actions",2,"margin-top","16px"],["class","approval-actions",4,"ngIf"],["class","step-info",4,"ngIf"],[3,"nzOnOk","nzOnCancel","nzVisibleChange","nzVisible","nzTitle","nzOkText","nzOkType","nzOkLoading"],["nz-input","","rows","3","placeholder","\u8ACB\u8F38\u5165\u5BE9\u6279\u610F\u898B\uFF08\u9078\u586B\uFF09",3,"ngModelChange","ngModel"],[3,"nzTitle","nzDescription","nzIcon"],[1,"approval-actions"],["nz-button","","nzType","primary","nzSize","small",3,"click","nzLoading"],["nz-icon","","nzType","check"],["nz-button","","nzDanger","","nzSize","small",2,"margin-left","8px",3,"click","nzLoading"],["nz-icon","","nzType","close"],[1,"step-info"],[1,"waiting-info"],["nz-icon","","nzType","clock-circle"]],template:function(t,n){t&1&&(a(0,"div",0)(1,"h4"),m(2,"\u5BE9\u6279\u6D41\u7A0B"),s(),a(3,"nz-steps",1),S(4,Di,1,3,"nz-step",2),s(),a(5,"div",3),S(6,Fi,7,2,"div",4)(7,ki,4,1,"div",5),s(),a(8,"nz-modal",6),f("nzOnOk",function(){return n.handleApproval()})("nzOnCancel",function(){return n.closeModal()})("nzVisibleChange",function(r){return n.onModalVisibleChange(r)}),a(9,"div")(10,"p"),m(11),s(),a(12,"textarea",7),f("ngModelChange",function(r){return n.approvalComment.set(r)}),m(13,"          "),s()()()()),t&2&&(c(3),l("nzCurrent",n.currentStepIndex())("nzStatus",n.getStepsStatus()),c(),l("ngForOf",n.payment.steps),c(2),l("ngIf",n.canCurrentUserApprove()),c(),l("ngIf",!n.canCurrentUserApprove()&&n.getCurrentStep()),c(),l("nzVisible",n.showModal())("nzTitle",n.modalTitle())("nzOkText",n.isApproving()?"\u78BA\u8A8D\u6838\u51C6":"\u78BA\u8A8D\u62D2\u7D55")("nzOkType",n.isApproving()?"primary":"default")("nzOkLoading",n.isProcessing()),c(3),q(n.modalMessage()),c(),l("ngModel",n.approvalComment()))},dependencies:[K,vt,wt,Ft,nt,it,Dt,In,Pn,En,j,H,$,U,rt,ot,Tt,xt,E,N,kt],styles:[".workflow-steps-container[_ngcontent-%COMP%]{padding:16px;background-color:#fafafa;border-radius:6px;margin-top:12px}.workflow-steps-container[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%]{margin:0 0 16px;color:#262626;font-size:14px}.workflow-actions[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center}.approval-actions[_ngcontent-%COMP%]{display:flex;gap:8px}.waiting-info[_ngcontent-%COMP%]{color:#8c8c8c;font-size:12px}.waiting-info[_ngcontent-%COMP%]   span[nz-icon][_ngcontent-%COMP%]{margin-right:4px}"],changeDetection:0});var Pt=lt;var Z=class Z{constructor(){this.storage=h(He);this.message=h(et)}validateFile(e){if(!["image/jpeg","image/png","image/gif","application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"].includes(e.type))return this.message.error("\u4E0D\u652F\u63F4\u7684\u6587\u4EF6\u985E\u578B\uFF01\u53EA\u80FD\u4E0A\u50B3\u5716\u7247\u3001PDF\u6216Office\u6587\u6A94"),!1;let n=10*1024*1024;return e.size>n?(this.message.error("\u6587\u4EF6\u5927\u5C0F\u4E0D\u80FD\u8D85\u904E 10MB\uFF01"),!1):!0}uploadFile(e,t){return z(this,null,function*(){if(!this.validateFile(e))throw new Error("File validation failed");try{let i=`${Date.now()}_${e.name}`,r=`contract-payments/${t}/${i}`,g=Zt(this.storage,r),C=yield qe(g,e);return yield Ge(C.ref)}catch(n){throw console.error("Upload error:",n),this.message.error("\u6587\u4EF6\u4E0A\u50B3\u5931\u6557"),n}})}deleteFile(e){return z(this,null,function*(){try{let t=Zt(this.storage,e);yield je(t)}catch(t){throw console.error("Delete error:",t),this.message.error("\u6587\u4EF6\u522A\u9664\u5931\u6557"),t}})}getFileNameFromUrl(e){try{let t=e.split("/"),n=t[t.length-1];return decodeURIComponent(n.split("?")[0]).replace(/^\d+_/,"")}catch{return"Unknown File"}}getFileTypeIcon(e){switch(e.split(".").pop()?.toLowerCase()){case"pdf":return"file-pdf";case"doc":case"docx":return"file-word";case"xls":case"xlsx":return"file-excel";case"jpg":case"jpeg":case"png":case"gif":return"file-image";default:return"file"}}};Z.\u0275fac=function(t){return new(t||Z)},Z.\u0275prov=zt({token:Z,factory:Z.\u0275fac,providedIn:"root"});var It=Z;var Mi=()=>({showPreviewIcon:!0,showRemoveIcon:!0,showDownloadIcon:!0}),pt=class pt{constructor(e,t){this.fb=e;this.message=t;this.payment=null;this.contractId="";this.formSubmit=new P;this.formCancel=new P;this.isSubmitting=y(!1);this.editMode=O(()=>!!this.payment);this.fileList=y([]);this.uploading=y(!1);this.attachmentService=h(It);this.beforeUpload=e=>this.fileList().length>=5?(this.message.error("\u6700\u591A\u53EA\u80FD\u4E0A\u50B35\u500B\u6587\u4EF6\uFF01"),!1):this.attachmentService.validateFile(e);this.customUpload=e=>{this.uploading.set(!0),this.attachmentService.uploadFile(e.file,this.contractId||"temp").then(t=>{e.onSuccess(t,e.file),this.message.success(`${e.file.name} \u4E0A\u50B3\u6210\u529F`)}).catch(t=>{e.onError(t,e.file),this.message.error(`${e.file.name} \u4E0A\u50B3\u5931\u6557`)}).finally(()=>{this.uploading.set(!1)})};this.paymentForm=this.createForm()}ngOnInit(){this.payment&&this.populateForm()}createForm(){return this.fb.group({amount:[null,[Jt.required,Jt.min(.01)]],remark:[""],attachments:[[]]})}populateForm(){if(this.payment){this.paymentForm.patchValue({amount:this.payment.amount,remark:this.payment.remark,attachments:this.payment.attachments});let e=this.payment.attachments.map((t,n)=>({uid:`${n}`,name:this.attachmentService.getFileNameFromUrl(t),status:"done",url:t,size:0,type:""}));this.fileList.set(e)}}handleFileChange(e){let t=[...e.fileList];t=t.slice(-5),this.fileList.set(t);let n=t.filter(i=>i.status==="done").map(i=>i.response?i.response:i.url||"").filter(i=>i);this.paymentForm.patchValue({attachments:n})}onSubmit(){if(this.paymentForm.valid&&!this.isSubmitting()){this.isSubmitting.set(!0);let e={amount:this.paymentForm.value.amount,remark:this.paymentForm.value.remark||"",attachments:this.paymentForm.value.attachments||[]};this.formSubmit.emit(e),setTimeout(()=>this.isSubmitting.set(!1),1e3)}}onCancel(){this.formCancel.emit()}resetForm(){this.paymentForm.reset(),this.fileList.set([]),this.isSubmitting.set(!1)}};pt.\u0275fac=function(t){return new(t||pt)(G(tn),G(et))},pt.\u0275cmp=x({type:pt,selectors:[["app-contract-payment-form"]],inputs:{payment:"payment",contractId:"contractId"},outputs:{formSubmit:"formSubmit",formCancel:"formCancel"},decls:29,vars:20,consts:[["nz-form","",3,"ngSubmit","formGroup"],["nzRequired","",3,"nzSpan"],["nzErrorTip","\u8ACB\u8F38\u5165\u6709\u6548\u7684\u4ED8\u6B3E\u91D1\u984D",3,"nzSpan"],["formControlName","amount","nzPlaceHolder","\u8ACB\u8F38\u5165\u4ED8\u6B3E\u91D1\u984D",2,"width","100%",3,"nzMin","nzStep"],[3,"nzSpan"],["nz-input","","formControlName","remark","rows","3","placeholder","\u8ACB\u8F38\u5165\u5099\u8A3B\u8AAA\u660E"],["nzMultiple","",3,"nzChange","nzFileList","nzBeforeUpload","nzCustomRequest","nzShowUploadList"],["nz-button","",3,"nzLoading"],["nz-icon","","nzType","upload"],[2,"margin-top","8px","color","#8c8c8c","font-size","12px"],[3,"nzOffset","nzSpan"],["nz-button","","nzType","primary","type","submit",3,"nzLoading","disabled"],["nz-button","","type","button",2,"margin-left","8px",3,"click"]],template:function(t,n){t&1&&(a(0,"form",0),f("ngSubmit",function(){return n.onSubmit()}),a(1,"nz-form-item")(2,"nz-form-label",1),m(3,"\u4ED8\u6B3E\u91D1\u984D"),s(),a(4,"nz-form-control",2),_(5,"nz-input-number",3),s()(),a(6,"nz-form-item")(7,"nz-form-label",4),m(8,"\u5099\u8A3B"),s(),a(9,"nz-form-control",4)(10,"textarea",5),m(11,"          "),s()()(),a(12,"nz-form-item")(13,"nz-form-label",4),m(14,"\u9644\u4EF6"),s(),a(15,"nz-form-control",4)(16,"nz-upload",6),f("nzChange",function(r){return n.handleFileChange(r)}),a(17,"button",7),_(18,"span",8),a(19,"span"),m(20,"\u4E0A\u50B3\u9644\u4EF6"),s()()(),a(21,"div",9),m(22," \u652F\u63F4\u5716\u7247\u3001PDF\u3001Word\u3001Excel\u6587\u4EF6\uFF0C\u55AE\u500B\u6587\u4EF6\u4E0D\u8D85\u904E10MB\uFF0C\u6700\u591A5\u500B\u6587\u4EF6 "),s()()(),a(23,"nz-form-item")(24,"nz-form-control",10)(25,"button",11),m(26),s(),a(27,"button",12),f("click",function(){return n.onCancel()}),m(28," \u53D6\u6D88 "),s()()()()),t&2&&(l("formGroup",n.paymentForm),c(2),l("nzSpan",6),c(2),l("nzSpan",18),c(),l("nzMin",.01)("nzStep",.01),c(2),l("nzSpan",6),c(2),l("nzSpan",18),c(4),l("nzSpan",6),c(2),l("nzSpan",18),c(),l("nzFileList",n.fileList())("nzBeforeUpload",n.beforeUpload)("nzCustomRequest",n.customUpload)("nzShowUploadList",we(19,Mi)),c(),l("nzLoading",n.uploading()),c(7),l("nzOffset",6)("nzSpan",18),c(),l("nzLoading",n.isSubmitting())("disabled",!n.paymentForm.valid||n.isSubmitting()),c(),T(" ",n.editMode()?"\u66F4\u65B0":"\u5275\u5EFA","\u4ED8\u6B3E\u8ACB\u6C42 "))},dependencies:[K,en,Xe,nt,it,Ye,Je,Ke,kn,Sn,bn,Tn,xn,Fn,Dn,rt,ot,wn,vn,j,H,$,U,Nn,Mn,E,N],encapsulation:2,changeDetection:0});var Bt=pt;var Ni=(o,e)=>e.key,Ei=(o,e)=>e.name;function Pi(o,e){o&1&&(a(0,"div",23),m(1,"\u8F09\u5165\u4E2D..."),s())}function Ii(o,e){if(o&1){let t=v();a(0,"div",24)(1,"p"),m(2,"\u66AB\u7121\u4ED8\u6B3E\u8ACB\u6C42"),s(),a(3,"button",26),f("click",function(){u(t);let i=p(2).$implicit,r=p();return d(r.addPayment(i))}),m(4," \u65B0\u589E\u7B2C\u4E00\u500B\u4ED8\u6B3E\u8ACB\u6C42 "),s()()}}function Bi(o,e){if(o&1&&(a(0,"nz-tag",29),m(1),s()),o&2){let t=e.$implicit,n=p(5);l("nzColor",n.getStepStatusColor(t.status)),c(),T(" ",t.name," ")}}function Oi(o,e){if(o&1&&(a(0,"div",30),_(1,"span",37),m(2),s()),o&2){let t=p().$implicit;c(2),T(" ",t.attachments.length," \u500B\u9644\u4EF6 ")}}function Vi(o,e){if(o&1){let t=v();a(0,"button",38),f("click",function(){u(t);let i=p().$implicit,r=p(4);return d(r.submitPayment(i.key))}),m(1," \u63D0\u4EA4\u5BE9\u6279 "),s()}if(o&2){let t=p().$implicit,n=p(4);l("nzLoading",n.paymentSubmitting().has(t.key))}}function Li(o,e){if(o&1){let t=v();a(0,"tr")(1,"td",39)(2,"app-contract-workflow-steps",40),f("workflowUpdated",function(){u(t);let i=p(4).$implicit,r=p();return d(r.onWorkflowUpdated(i.key))}),s()()()}if(o&2){let t=p().$implicit;c(2),l("payment",t)}}function Ai(o,e){if(o&1){let t=v();a(0,"tr")(1,"td"),m(2),Se(3,"currency"),s(),a(4,"td")(5,"nz-tag",27),m(6),s()(),a(7,"td")(8,"div",28),ht(9,Bi,2,2,"nz-tag",29,Ei),s()(),a(11,"td")(12,"div"),m(13),s(),k(14,Oi,3,1,"div",30),s(),a(15,"td")(16,"button",31),f("click",function(){let i=u(t).$implicit,r=p(4);return d(r.editPayment(i))}),m(17," \u7DE8\u8F2F "),s(),S(18,Vi,2,1,"button",32),a(19,"button",33),f("click",function(){let i=u(t).$implicit,r=p(4);return d(r.toggleWorkflowSteps(i.key))}),_(20,"span",34),m(21," \u6D41\u7A0B "),s(),a(22,"nz-popconfirm",35),f("nzOnConfirm",function(){let i=u(t).$implicit,r=p(4);return d(r.deletePayment(i.key))}),a(23,"button",36),m(24," \u522A\u9664 "),s()()()(),k(25,Li,3,1,"tr")}if(o&2){let t=e.$implicit,n=p(4);c(2),q(xe(3,10,t.amount,"TWD","symbol","1.0-0")),c(3),l("nzColor",n.getPaymentStatusColor(t.status)),c(),T(" ",n.getPaymentStatusText(t.status)," "),c(3),yt(t.steps),c(4),q(n.formatPaymentDate(t.createdAt)),c(),M(t.attachments&&t.attachments.length>0?14:-1),c(2),l("disabled",t.status==="approved"||t.status==="rejected"),c(2),l("ngIf",t.status==="draft"),c(2),l("nzType",n.workflowStepsExpanded().has(t.key)?"up":"down"),c(3),l("disabled",t.status==="approved"),c(2),M(n.workflowStepsExpanded().has(t.key)?25:-1)}}function Ri(o,e){if(o&1&&(a(0,"nz-table",25)(1,"thead")(2,"tr")(3,"th"),m(4,"\u4ED8\u6B3E\u91D1\u984D"),s(),a(5,"th"),m(6,"\u72C0\u614B"),s(),a(7,"th"),m(8,"\u5DE5\u4F5C\u6D41\u7A0B"),s(),a(9,"th"),m(10,"\u5275\u5EFA\u6642\u9593"),s(),a(11,"th"),m(12,"\u64CD\u4F5C"),s()()(),a(13,"tbody"),ht(14,Ai,26,15,null,null,Ni),s()()),o&2){let t=p(2).$implicit,n=p();l("nzData",n.getContractPayments(t.key))("nzShowPagination",!1),c(14),yt(n.getContractPayments(t.key))}}function Wi(o,e){if(o&1){let t=v();a(0,"tr")(1,"td",18)(2,"div",19)(3,"div",20)(4,"h4"),m(5,"\u4ED8\u6B3E\u8ACB\u6C42\u5217\u8868"),s(),a(6,"button",21),f("click",function(){u(t);let i=p().$implicit,r=p();return d(r.addPayment(i))}),_(7,"span",22),m(8," \u65B0\u589E\u4ED8\u6B3E\u8ACB\u6C42 "),s()(),k(9,Pi,2,0,"div",23)(10,Ii,5,0,"div",24)(11,Ri,16,2,"nz-table",25),s()()()}if(o&2){let t=p().$implicit,n=p();c(6),l("nzLoading",n.paymentLoading().has(t.key)),c(3),M(n.paymentLoading().has(t.key)?9:n.getContractPayments(t.key).length===0?10:11)}}function $i(o,e){if(o&1){let t=v();a(0,"tr",9)(1,"td",10),f("nzExpandChange",function(i){let r=u(t).$implicit,g=p();return d(g.onExpandChange(r.key,i))}),s(),a(2,"td"),m(3),s(),a(4,"td")(5,"div",11),f("nzClick",function(){let i=u(t).$implicit,r=p();return d(r.currentDropdownRow=i)}),a(6,"a",12),f("click",function(){let i=u(t).$implicit,r=p();return d(r.currentDropdownRow=i)}),m(7),_(8,"span",13),s()()(),a(9,"td")(10,"div",14),f("click",function(){let i=u(t).$implicit,r=p();return d(r.startEdit(i.key))}),m(11),s(),a(12,"input",15),Ct("ngModelChange",function(i){let r=u(t).$implicit;return gt(r.contractName,i)||(r.contractName=i),d(i)}),f("blur",function(){let i=u(t).$implicit,r=p();return d(r.stopEdit(i))}),s()(),a(13,"td")(14,"div",14),f("click",function(){let i=u(t).$implicit,r=p();return d(r.startEdit(i.key))}),m(15),s(),a(16,"input",15),Ct("ngModelChange",function(i){let r=u(t).$implicit;return gt(r.contractCode,i)||(r.contractCode=i),d(i)}),f("blur",function(){let i=u(t).$implicit,r=p();return d(r.stopEdit(i))}),s()(),a(17,"td")(18,"div",14),f("click",function(){let i=u(t).$implicit,r=p();return d(r.startEdit(i.key))}),m(19),s(),a(20,"input",15),Ct("ngModelChange",function(i){let r=u(t).$implicit;return gt(r.feeCode,i)||(r.feeCode=i),d(i)}),f("blur",function(){let i=u(t).$implicit,r=p();return d(r.stopEdit(i))}),s()(),a(21,"td")(22,"div",14),f("click",function(){let i=u(t).$implicit,r=p();return d(r.startEdit(i.key))}),m(23),s(),a(24,"input",16),Ct("ngModelChange",function(i){let r=u(t).$implicit;return gt(r.amount,i)||(r.amount=i),d(i)}),f("blur",function(){let i=u(t).$implicit,r=p();return d(r.stopEdit(i))}),s()(),a(25,"td")(26,"a",17),f("nzOnConfirm",function(){let i=u(t).$implicit,r=p();return d(r.deleteRow(i.key))}),m(27,"\u522A\u9664"),s()()(),k(28,Wi,12,2,"tr")}if(o&2){let t=e.$implicit,n=p(),i=I(26);c(),l("nzExpand",n.expandSet().has(t.key)),c(2),q(t.contractSerial),c(2),l("nzDropdownMenu",i),c(2),T("",t.client," "),c(3),l("hidden",n.editId===t.key),c(),T(" ",t.contractName," "),c(),l("hidden",n.editId!==t.key),ft("ngModel",t.contractName),c(2),l("hidden",n.editId===t.key),c(),T(" ",t.contractCode," "),c(),l("hidden",n.editId!==t.key),ft("ngModel",t.contractCode),c(2),l("hidden",n.editId===t.key),c(),T(" ",t.feeCode," "),c(),l("hidden",n.editId!==t.key),ft("ngModel",t.feeCode),c(2),l("hidden",n.editId===t.key),c(),T(" ",t.amount," "),c(),l("hidden",n.editId!==t.key),ft("ngModel",t.amount),c(4),M(n.expandSet().has(t.key)?28:-1)}}function Ui(o,e){if(o&1){let t=v();a(0,"li",41),f("click",function(){let i=u(t).$implicit,r=p();return d(r.changeClient(r.currentDropdownRow,i))}),m(1),s()}if(o&2){let t=e.$implicit;c(),q(t)}}function Hi(o,e){if(o&1){let t=v();a(0,"div")(1,"app-contract-payment-form",42),f("formSubmit",function(i){u(t);let r=p();return d(r.onPaymentFormSubmit(i))})("formCancel",function(){u(t);let i=p();return d(i.onPaymentModalCancel())}),s()()}if(o&2){let t,n=p();c(),l("payment",n.editingPayment())("contractId",((t=n.currentContract())==null?null:t.key)||"")}}var mt=class mt{constructor(e,t,n){this.contractService=e;this.paymentService=t;this.hubCrud=n;this.contracts=[];this.editId=null;this.clients=[];this.currentDropdownRow=null;this.expandSet=y(new Set);this.contractPayments=y(new Map);this.paymentLoading=y(new Set);this.paymentSubmitting=y(new Set);this.workflowStepsExpanded=y(new Set);this.showPaymentModal=y(!1);this.currentContract=y(null);this.editingPayment=y(null)}ngOnInit(){this.refresh(),this.contractService.getClientsSettings().then(e=>{this.clients=e?.list||[]})}refresh(){this.contractService.list().subscribe(e=>this.contracts=e)}addRow(){return z(this,null,function*(){let[e,t]=yield Promise.all([this.contractService.getDefaultClient(),this.contractService.getNextContractSerial()]),n={contractSerial:t,client:e,contractName:"",contractCode:"",feeCode:"",amount:0},i=yield this.contractService.add(n);this.contracts=[...this.contracts,L(F({},n),{key:i})],setTimeout(()=>{this.startEdit(i)},200)})}startEdit(e){e&&(this.editId=e,setTimeout(()=>{let t=document.querySelector("input[nz-input]:not([hidden])");t&&t.focus()},50))}stopEdit(e){return z(this,null,function*(){e.key&&(yield this.contractService.update(e.key,e)),this.editId=null})}deleteRow(e){return z(this,null,function*(){e&&(yield this.contractService.delete(e),this.contracts=this.contracts.filter(t=>t.key!==e))})}changeClient(e,t){return z(this,null,function*(){e&&e.key&&e.client!==t&&(e.client=t,yield this.contractService.update(e.key,{client:t}))})}onExpandChange(e,t){return z(this,null,function*(){let n=this.expandSet();t?(n.add(e),this.expandSet.set(new Set(n)),yield this.loadContractPayments(e)):(n.delete(e),this.expandSet.set(new Set(n)))})}loadContractPayments(e){return z(this,null,function*(){let t=this.paymentLoading();t.add(e),this.paymentLoading.set(new Set(t));try{let n=yield this.paymentService.listByContract(e),i=this.contractPayments();i.set(e,n),this.contractPayments.set(new Map(i))}catch(n){console.error("Failed to load payments:",n)}finally{let n=this.paymentLoading();n.delete(e),this.paymentLoading.set(new Set(n))}})}getContractPayments(e){return this.contractPayments().get(e)||[]}addPayment(e){if(!e.key){console.error("Contract key is missing");return}this.currentContract.set(e),this.editingPayment.set(null),this.showPaymentModal.set(!0)}editPayment(e){this.editingPayment.set(e),this.currentContract.set(this.contracts.find(t=>t.key===e.contractId)||null),this.showPaymentModal.set(!0)}onPaymentFormSubmit(e){return z(this,null,function*(){try{if(this.editingPayment())yield this.paymentService.update(this.editingPayment().key,{amount:e.amount,remark:e.remark,attachments:e.attachments}),console.log("\u4ED8\u6B3E\u8ACB\u6C42\u66F4\u65B0\u6210\u529F");else{let n=this.currentContract();if(!n?.key)throw new Error("\u5408\u7D04\u8CC7\u8A0A\u7F3A\u5931");yield this.paymentService.add(n.key,e.amount,e.remark,n.client),console.log("\u4ED8\u6B3E\u8ACB\u6C42\u5275\u5EFA\u6210\u529F")}this.onPaymentModalCancel();let t=this.currentContract()?.key;t&&(yield this.loadContractPayments(t))}catch(t){console.error("\u64CD\u4F5C\u5931\u6557\uFF1A",t)}})}onPaymentModalCancel(){this.showPaymentModal.set(!1),this.currentContract.set(null),this.editingPayment.set(null)}submitPayment(e){return z(this,null,function*(){let t=this.paymentSubmitting();t.add(e),this.paymentSubmitting.set(new Set(t));try{yield this.paymentService.submitPayment(e);let n=Array.from(this.expandSet());for(let i of n)yield this.loadContractPayments(i);console.log("Payment submitted successfully")}catch(n){console.error("Failed to submit payment:",n)}finally{let n=this.paymentSubmitting();n.delete(e),this.paymentSubmitting.set(new Set(n))}})}deletePayment(e){return z(this,null,function*(){try{yield this.paymentService.delete(e);let t=Array.from(this.expandSet());for(let n of t)yield this.loadContractPayments(n)}catch(t){console.error("Failed to delete payment:",t)}})}getPaymentStatusColor(e){return{draft:"default",submitted:"blue",reviewing:"orange",approved:"green",rejected:"red",invoiced:"purple",countdown:"cyan"}[e]||"default"}getPaymentStatusText(e){return{draft:"\u8349\u7A3F",submitted:"\u5DF2\u63D0\u4EA4",reviewing:"\u5BE9\u6838\u4E2D",approved:"\u5DF2\u6838\u51C6",rejected:"\u5DF2\u62D2\u7D55",invoiced:"\u5DF2\u958B\u7968",countdown:"\u5012\u6578\u4E2D"}[e]||e}getStepStatusColor(e){return{pending:"orange",done:"green",rejected:"red",waiting:"default"}[e]||"default"}formatPaymentDate(e){if(!e)return"";try{return e.toDate?e.toDate().toLocaleDateString("zh-TW"):e instanceof Date?e.toLocaleDateString("zh-TW"):typeof e=="number"?new Date(e).toLocaleDateString("zh-TW"):""}catch(t){return console.error("Date formatting error:",t),""}}toggleWorkflowSteps(e){let t=this.workflowStepsExpanded();t.has(e)?t.delete(e):t.add(e),this.workflowStepsExpanded.set(new Set(t))}onWorkflowUpdated(e){return z(this,null,function*(){yield this.loadContractPayments(e)})}};mt.\u0275fac=function(t){return new(t||mt)(G(On),G(ct),G(at))},mt.\u0275cmp=x({type:mt,selectors:[["contract-list"]],decls:31,vars:6,consts:[["editRowTable",""],["menuRef","nzDropdownMenu"],[3,"onAction"],["nzBordered","",3,"nzData"],["nzWidth","50px"],["nz-menu",""],["nz-menu-item","",3,"click",4,"ngFor","ngForOf"],[3,"nzOnCancel","nzVisible","nzTitle","nzFooter","nzWidth"],[4,"nzModalContent"],[1,"editable-row"],[3,"nzExpandChange","nzExpand"],["nz-dropdown","","nzTrigger","click",3,"nzClick","nzDropdownMenu"],["nz-dropdown","",3,"click"],["nz-icon","","nzType","down"],[1,"editable-cell",3,"click","hidden"],["type","text","nz-input","",3,"ngModelChange","blur","hidden","ngModel"],["type","number","nz-input","",3,"ngModelChange","blur","hidden","ngModel"],["nz-popconfirm","","nzPopconfirmTitle","\u78BA\u5B9A\u522A\u9664\uFF1F",3,"nzOnConfirm"],["colspan","8",1,"payment-expand-row"],[1,"payment-sub-table"],[1,"payment-header"],["nz-button","","nzType","primary","nzSize","small",3,"click","nzLoading"],["nz-icon","","nzType","plus"],[1,"payment-loading"],[1,"payment-empty"],["nzSize","small",3,"nzData","nzShowPagination"],["nz-button","","nzType","dashed",3,"click"],[3,"nzColor"],[1,"workflow-steps"],["nzSize","small",2,"margin-right","4px","margin-bottom","2px",3,"nzColor"],[1,"attachment-info"],["nz-button","","nzType","link","nzSize","small",3,"click","disabled"],["nz-button","","nzType","primary","nzSize","small","style","margin-left: 4px;",3,"nzLoading","click",4,"ngIf"],["nz-button","","nzType","link","nzSize","small",2,"margin-left","4px",3,"click"],["nz-icon","",3,"nzType"],["nzTitle","\u78BA\u5B9A\u8981\u522A\u9664\u6B64\u4ED8\u6B3E\u8ACB\u6C42\u55CE\uFF1F",3,"nzOnConfirm"],["nz-button","","nzType","link","nzSize","small","nzDanger","","nz-popconfirm","",3,"disabled"],["nz-icon","","nzType","paper-clip"],["nz-button","","nzType","primary","nzSize","small",2,"margin-left","4px",3,"click","nzLoading"],["colspan","5",1,"workflow-steps-row"],[3,"workflowUpdated","payment"],["nz-menu-item","",3,"click"],[3,"formSubmit","formCancel","payment","contractId"]],template:function(t,n){if(t&1){let i=v();a(0,"app-fab",2),f("onAction",function(){return u(i),d(n.addRow())}),s(),_(1,"br")(2,"br"),a(3,"nz-table",3,0)(5,"thead")(6,"tr"),_(7,"th",4),a(8,"th"),m(9,"\u5E8F\u865F"),s(),a(10,"th"),m(11,"\u696D\u4E3B"),s(),a(12,"th"),m(13,"\u5408\u7D04\u540D\u7A31"),s(),a(14,"th"),m(15,"\u5408\u7D04\u6848\u865F\u8B58\u5225\u78BC"),s(),a(16,"th"),m(17,"\u5408\u7D04\u8CBB\u7528\u8B58\u5225\u78BC"),s(),a(18,"th"),m(19,"\u5408\u7D04\u91D1\u984D"),s(),a(20,"th"),m(21,"\u64CD\u4F5C"),s()()(),a(22,"tbody"),ht(23,$i,29,21,null,null,ge),s()(),a(25,"nz-dropdown-menu",null,1)(27,"ul",5),S(28,Ui,2,1,"li",6),s()(),a(29,"nz-modal",7),f("nzOnCancel",function(){return u(i),d(n.onPaymentModalCancel())}),S(30,Hi,2,2,"div",8),s()}if(t&2){let i=I(4);c(3),l("nzData",n.contracts),c(20),yt(i.data),c(5),l("ngForOf",n.clients),c(),l("nzVisible",n.showPaymentModal())("nzTitle",n.editingPayment()?"\u7DE8\u8F2F\u4ED8\u6B3E\u8ACB\u6C42":"\u65B0\u589E\u4ED8\u6B3E\u8ACB\u6C42")("nzFooter",null)("nzWidth",600)}},dependencies:[K,vt,wt,Ft,nt,Ze,it,Dt,yn,_n,dn,gn,fn,hn,Cn,zn,j,H,$,U,rt,ot,kt,un,mn,pn,an,rn,sn,cn,ln,Tt,xt,Ve,on,nn,E,N,Nt,Pt,Bt,ke],styles:[".editable-cell[_ngcontent-%COMP%]{position:relative;padding:5px 12px;cursor:pointer}.editable-row[_ngcontent-%COMP%]:hover   .editable-cell[_ngcontent-%COMP%]{border:1px solid #d9d9d9;border-radius:4px;padding:4px 11px}.payment-expand-row[_ngcontent-%COMP%]{padding:0!important}.payment-sub-table[_ngcontent-%COMP%]{padding:16px}.payment-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}.payment-header[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%]{margin:0;font-size:14px}.payment-loading[_ngcontent-%COMP%], .payment-empty[_ngcontent-%COMP%]{text-align:center;padding:24px}.payment-empty[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin-bottom:12px}.workflow-steps[_ngcontent-%COMP%]{max-width:200px}.attachment-info[_ngcontent-%COMP%]{margin-top:4px;font-size:12px}.attachment-info[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{margin-right:4px}.workflow-steps-row[_ngcontent-%COMP%]{padding:0!important}"],changeDetection:0});var Ot=mt;var ut=class ut{};ut.\u0275fac=function(t){return new(t||ut)},ut.\u0275cmp=x({type:ut,selectors:[["hub-contract"]],decls:1,vars:0,template:function(t,n){t&1&&_(0,"contract-list")},dependencies:[Ot],encapsulation:2});var Wn=ut;export{Wn as HubContractComponent};
