import{a as me,b as fe}from"./chunk-TTLT4QMP.js";import{a as de,b as ce}from"./chunk-5YO4PIE7.js";import"./chunk-W5AQKPAW.js";import{a as re,c as oe,d as ae,e as se}from"./chunk-JSW4L7WF.js";import{a as ne,b as ie}from"./chunk-3AJA4UAR.js";import{d as q}from"./chunk-RHSNDLDC.js";import{i as G,j as R,k as $}from"./chunk-VPG4RKW7.js";import{k as te}from"./chunk-A6I6NVJK.js";import"./chunk-H7YPP55E.js";import{a as Z,b as ee}from"./chunk-SNCQL3XC.js";import{d as Y}from"./chunk-IUJTST7W.js";import{a as Q,c as X}from"./chunk-GUFTXPTT.js";import"./chunk-FSJ6KERW.js";import"./chunk-UATVLLJJ.js";import"./chunk-BRKXCE7P.js";import"./chunk-WHJAXXAS.js";import{y as H}from"./chunk-NB4EIDVA.js";import"./chunk-43QWISWI.js";import"./chunk-4OGGW47F.js";import"./chunk-JHZVO6A4.js";import"./chunk-Z2B7QBBP.js";import"./chunk-QNTYQDQV.js";import{Aa as x,Hd as A,Ih as L,Jh as B,Nb as c,Ob as s,Pb as r,Qb as T,Th as O,Xb as I,_b as y,ai as K,bb as p,bc as m,ci as J,di as W,gb as _,nb as k,ni as le,oa as D,oi as pe,qc as l,rc as S,tb as v,uc as E,vc as j,wc as V,za as P,zd as U}from"./chunk-VMD4HRQF.js";import{i as C}from"./chunk-57BLH6QZ.js";var f=class f{convertToTree(t,e=100){let n=[],i=0;return t.filter(z=>z.trim()).slice(0,e).forEach(z=>{let h=z.trim();if(!h)return;let d={title:this.truncateTitle(h),key:`node-${i++}`,isLeaf:!0};n.push(d)}),n}truncateTitle(t,e=50){return t.length>e?t.substring(0,e)+"...":t}getAllKeys(t){let e=[];return t.forEach(n=>{e.push(n.key),n.children&&e.push(...this.getAllKeys(n.children))}),e}countNodes(t){let e=0;return t.forEach(n=>{e++,n.children&&(e+=this.countNodes(n.children))}),e}};f.\u0275fac=function(e){return new(e||f)},f.\u0275prov=D({token:f,factory:f.\u0275fac,providedIn:"root"});var w=f;var b={workerSrc:"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js",cMapUrl:"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/cmaps/",cMapPacked:!0,standardFontDataUrl:"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/standard_fonts/"};function ze(){return new Promise((o,t)=>{if(typeof window>"u"){t(new Error("PDF.js \u53EA\u80FD\u5728\u700F\u89BD\u5668\u74B0\u5883\u4E2D\u4F7F\u7528"));return}if(window.pdfjsLib){o();return}let e=document.createElement("script");e.src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js",e.onload=()=>{let n=window.pdfjsLib;n.GlobalWorkerOptions.workerSrc=b.workerSrc,n.cMapUrl=b.cMapUrl,n.cMapPacked=b.cMapPacked,n.standardFontDataUrl=b.standardFontDataUrl,n.GlobalWorkerOptions.verbosity=0,o()},e.onerror=()=>{t(new Error("PDF.js \u8F09\u5165\u5931\u6557"))},document.head.appendChild(e)})}function ye(){return typeof window<"u"&&!!window.pdfjsLib}function ge(){if(!ye())throw new Error("PDF.js \u672A\u521D\u59CB\u5316\uFF0C\u8ACB\u5148\u8ABF\u7528 initializePDFJS()");return window.pdfjsLib}var u=class u{constructor(){this.isInitialized=!1;this.initPDFJS()}initPDFJS(){return C(this,null,function*(){if(!this.isInitialized)try{yield ze(),this.isInitialized=!0,console.log("PDF.js \u521D\u59CB\u5316\u6210\u529F")}catch(t){throw console.error("PDF.js \u521D\u59CB\u5316\u5931\u6557:",t),new Error("PDF \u89E3\u6790\u5EAB\u521D\u59CB\u5316\u5931\u6557")}})}parsePDF(t){return C(this,null,function*(){try{this.isInitialized||(yield this.initPDFJS());let e=yield t.arrayBuffer(),a=yield ge().getDocument({data:e,verbosity:0}).promise,z=a.numPages,h=[];for(let d=1;d<=z;d++)try{let Fe=(yield(yield a.getPage(d)).getTextContent({normalizeWhitespace:!0})).items.map(F=>F.str).join(" ").split(`
`).filter(F=>F.trim());h.push(...Fe),d%10===0&&(yield new Promise(F=>setTimeout(F,0)))}catch(M){console.warn(`\u7B2C ${d} \u9801\u89E3\u6790\u5931\u6557:`,M)}return{success:!0,data:h,pageCount:z}}catch(e){return{success:!1,error:e instanceof Error?e.message:"PDF \u89E3\u6790\u5931\u6557",pageCount:0}}})}isValidPDF(t){return t.type==="application/pdf"||t.name.toLowerCase().endsWith(".pdf")}formatFileSize(t){if(t===0)return"0 Bytes";let e=1024,n=["Bytes","KB","MB","GB"],i=Math.floor(Math.log(t)/Math.log(e));return parseFloat((t/Math.pow(e,i)).toFixed(2))+" "+n[i]}getFileInfo(t){return{name:t.name,size:this.formatFileSize(t.size),type:t.type}}};u.\u0275fac=function(e){return new(e||u)},u.\u0275prov=D({token:u,factory:u.\u0275fac,providedIn:"root"});var N=u;function Pe(o,t){o&1&&(s(0,"div",10)(1,"nz-empty",11)(2,"span"),l(3,"\u5C1A\u672A\u532F\u5165 PDF \u6A94\u6848"),r()()())}function xe(o,t){if(o&1){let e=I();s(0,"nz-tree",12),y("nzExpandChange",function(i){P(e);let a=m();return x(a.onExpandChange(i))})("nzClick",function(i){P(e);let a=m();return x(a.onNodeClick(i))}),r()}if(o&2){let e=m();c("nzData",e.treeData)("nzBlockNode",!0)("nzShowLine",!0)("nzShowIcon",!0)("nzExpandedKeys",e.expandedKeys)}}function _e(o,t){if(o&1&&(s(0,"nz-form-item")(1,"nz-form-label"),l(2,"\u6A94\u6848\u4FE1\u606F"),r(),s(3,"nz-form-control")(4,"div",16)(5,"p")(6,"strong"),l(7,"\u6A94\u540D\uFF1A"),r(),l(8),r(),s(9,"p")(10,"strong"),l(11,"\u5927\u5C0F\uFF1A"),r(),l(12),r()()()()),o&2){let e=m(2);p(8),S(e.getFileInfo(e.selectedFile).name),p(4),S(e.getFileInfo(e.selectedFile).size)}}function ve(o,t){if(o&1){let e=I();s(0,"div"),T(1,"nz-alert",13),s(2,"nz-form-item")(3,"nz-form-label"),l(4,"\u9078\u64C7\u6A94\u6848"),r(),s(5,"nz-form-control")(6,"input",14),y("change",function(i){P(e);let a=m();return x(a.onFileSelected(i))}),r()()(),v(7,_e,13,2,"nz-form-item",15),r()}if(o&2){let e=m();p(7),c("ngIf",e.selectedFile)}}var g=class g{constructor(t,e,n){this.message=t;this.pdfService=e;this.treeConverter=n;this.treeData=[];this.expandedKeys=[];this.isUploadModalVisible=!1;this.isProcessing=!1;this.selectedFile=null}showUploadModal(){this.isUploadModalVisible=!0,this.selectedFile=null}cancelUpload(){this.isUploadModalVisible=!1,this.selectedFile=null}onFileSelected(t){let e=t.target.files[0];e&&this.pdfService.isValidPDF(e)?this.selectedFile=e:this.message.error("\u8ACB\u9078\u64C7\u6709\u6548\u7684 PDF \u6A94\u6848")}getFileInfo(t){return this.pdfService.getFileInfo(t)}confirmUpload(){return C(this,null,function*(){if(!this.selectedFile){this.message.warning("\u8ACB\u9078\u64C7 PDF \u6A94\u6848");return}this.isProcessing=!0,this.message.info("\u958B\u59CB\u89E3\u6790 PDF \u6A94\u6848...");try{let t=yield this.pdfService.parsePDF(this.selectedFile);t.success&&t.data?(this.treeData=this.treeConverter.convertToTree(t.data),this.expandedKeys=this.treeConverter.getAllKeys(this.treeData),this.message.success(`PDF \u89E3\u6790\u6210\u529F\uFF0C\u5171 ${t.pageCount} \u9801\uFF0C\u751F\u6210 ${this.treeData.length} \u500B\u7BC0\u9EDE`),this.isUploadModalVisible=!1):this.message.error("PDF \u89E3\u6790\u5931\u6557\uFF1A"+(t.error||"\u672A\u77E5\u932F\u8AA4"))}catch(t){this.message.error("\u8655\u7406\u904E\u7A0B\u4E2D\u767C\u751F\u932F\u8AA4\uFF1A"+t)}finally{this.isProcessing=!1}})}onExpandChange(t){this.expandedKeys=t.keys}onNodeClick(t){console.log("\u7BC0\u9EDE\u9EDE\u64CA:",t)}};g.\u0275fac=function(e){return new(e||g)(_(q),_(N),_(w))},g.\u0275cmp=k({type:g,selectors:[["app-tree-pdf-import"]],decls:11,vars:5,consts:[["title","PDF \u532F\u5165\u529F\u80FD"],[2,"margin-bottom","16px"],["nz-button","","nzType","primary",3,"click"],["nz-icon","","nzType","upload"],[3,"nzSpinning"],[1,"tree-container"],["class","empty-state",4,"ngIf"],[3,"nzData","nzBlockNode","nzShowLine","nzShowIcon","nzExpandedKeys","nzExpandChange","nzClick",4,"ngIf"],["nzTitle","PDF \u6A94\u6848\u532F\u5165",3,"nzVisibleChange","nzOnCancel","nzOnOk","nzVisible","nzOkDisabled"],[4,"nzModalContent"],[1,"empty-state"],["nzNotFoundImage","simple"],[3,"nzExpandChange","nzClick","nzData","nzBlockNode","nzShowLine","nzShowIcon","nzExpandedKeys"],["nzType","info","nzMessage","\u652F\u63F4\u4E2D\u82F1\u6587 PDF \u6A94\u6848\uFF0C\u81EA\u52D5\u63D0\u53D6\u6587\u5B57\u4E26\u8F49\u63DB\u70BA\u6A39\u72C0\u7D50\u69CB",2,"margin-bottom","16px"],["type","file","accept",".pdf",2,"width","100%",3,"change"],[4,"ngIf"],[2,"padding","8px","background-color","#f5f5f5","border-radius","4px"]],template:function(e,n){e&1&&(s(0,"nz-card",0)(1,"div",1)(2,"button",2),y("click",function(){return n.showUploadModal()}),T(3,"span",3),l(4," \u9078\u64C7 PDF \u6A94\u6848 "),r()(),s(5,"nz-spin",4)(6,"div",5),v(7,Pe,4,0,"div",6)(8,xe,1,5,"nz-tree",7),r()(),s(9,"nz-modal",8),V("nzVisibleChange",function(a){return j(n.isUploadModalVisible,a)||(n.isUploadModalVisible=a),a}),y("nzOnCancel",function(){return n.cancelUpload()})("nzOnOk",function(){return n.confirmUpload()}),v(10,ve,8,1,"div",9),r()()),e&2&&(p(5),c("nzSpinning",n.isProcessing),p(2),c("ngIf",n.treeData.length===0),p(),c("ngIf",n.treeData.length>0),p(),E("nzVisible",n.isUploadModalVisible),c("nzOkDisabled",!n.selectedFile))},dependencies:[A,U,pe,le,fe,me,W,J,O,K,B,L,$,R,G,te,se,ie,ne,re,ae,oe,Y,ce,de,ee,Z,X,Q,H],styles:[".tree-container[_ngcontent-%COMP%]{border:1px solid #d9d9d9;border-radius:6px;min-height:300px;padding:16px}.empty-state[_ngcontent-%COMP%]{display:flex;justify-content:center;align-items:center;height:200px}"]});var he=g;export{he as TreePdfImportComponent};
