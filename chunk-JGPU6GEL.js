import{P as R,t as S}from"./chunk-3NIPPYFG.js";import{b as x,c as T,i as M,l as y,m as p}from"./chunk-XRAWGIG7.js";import{Ca as v,J as m,T as f,h as C,na as b,qa as h,sa as l}from"./chunk-A26OGSUO.js";import{a as g,b as _}from"./chunk-57BLH6QZ.js";var a=function(r){return r[r.Menu=0]="Menu",r[r.MenuForce=1]="MenuForce",r[r.URL=2]="URL",r}(a||{}),k=new h("REUSE_TAB_CACHED_MANAGER");var w=new h("REUSE_TAB_STORAGE_KEY"),D=new h("REUSE_TAB_STORAGE_STATE");var $e=(()=>{class r{injector=l(v);menuService=l(S);cached=l(k);stateKey=l(w);stateSrv=l(D);_inited=!1;_max=10;_keepingScroll=!1;_cachedChange=new C(null);_router$;removeUrlBuffer=null;positionBuffer={};componentRef;debug=!1;routeParamMatchMode="strict";mode=a.Menu;excludes=[];storageState=!1;get snapshot(){return this.injector.get(M).snapshot}get inited(){return this._inited}get curUrl(){return this.getUrl(this.snapshot)}set max(e){this._max=Math.min(Math.max(e,2),100);for(let t=this.cached.list.length;t>this._max;t--)this.cached.list.pop()}set keepingScroll(e){this._keepingScroll=e,this.initScroll()}get keepingScroll(){return this._keepingScroll}keepingScrollContainer;get items(){return this.cached.list}get count(){return this.cached.list.length}get change(){return this._cachedChange.asObservable()}set title(e){let t=this.curUrl;typeof e=="string"&&(e={text:e}),this.cached.title[t]=e,this.di("update current tag title: ",e),this._cachedChange.next({active:"title",url:t,title:e,list:this.cached.list})}index(e){return this.cached.list.findIndex(t=>t.url===e)}exists(e){return this.index(e)!==-1}get(e){return e&&this.cached.list.find(t=>t.url===e)||null}remove(e,t){let i=typeof e=="string"?this.index(e):e,n=i!==-1?this.cached.list[i]:null;return!n||!t&&!n.closable?!1:(this.destroy(n._handle),this.cached.list.splice(i,1),delete this.cached.title[e],!0)}close(e,t=!1){return this.removeUrlBuffer=e,this.remove(e,t),this._cachedChange.next({active:"close",url:e,list:this.cached.list}),this.di("close tag",e),!0}closeRight(e,t=!1){let i=this.index(e);for(let n=this.count-1;n>i;n--)this.remove(n,t);return this.removeUrlBuffer=null,this._cachedChange.next({active:"closeRight",url:e,list:this.cached.list}),this.di("close right tages",e),!0}clear(e=!1){this.cached.list.forEach(t=>{!e&&t.closable&&this.destroy(t._handle)}),this.cached.list=this.cached.list.filter(t=>!e&&!t.closable),this.removeUrlBuffer=null,this._cachedChange.next({active:"clear",list:this.cached.list}),this.di("clear all catch")}move(e,t){let i=this.cached.list.findIndex(s=>s.url===e);if(i===-1)return;let n=this.cached.list.slice();n.splice(t<0?n.length+t:t,0,n.splice(i,1)[0]),this.cached.list=n,this._cachedChange.next({active:"move",url:e,position:t,list:this.cached.list})}replace(e){let t=this.curUrl;this.injector.get(p).navigateByUrl(e).then(()=>{this.exists(t)?this.close(t,!0):this.removeUrlBuffer=t})}getTitle(e,t){if(this.cached.title[e])return this.cached.title[e];if(t&&t.data&&(t.data.titleI18n||t.data.title))return{text:t.data.title,i18n:t.data.titleI18n};let i=this.getMenu(e);return i?{text:i.text,i18n:i.i18n}:{text:e}}clearTitleCached(){this.cached.title={}}set closable(e){let t=this.curUrl;this.cached.closable[t]=e,this.di("update current tag closable: ",e),this._cachedChange.next({active:"closable",closable:e,list:this.cached.list})}getClosable(e,t){if(typeof this.cached.closable[e]<"u")return this.cached.closable[e];if(t&&t.data&&typeof t.data.reuseClosable=="boolean")return t.data.reuseClosable;let i=this.mode!==a.URL?this.getMenu(e):null;return i&&typeof i.reuseClosable=="boolean"?i.reuseClosable:!0}clearClosableCached(){this.cached.closable={}}getTruthRoute(e){let t=e;for(;t.firstChild;)t=t.firstChild;return t}getUrl(e){let t=this.getTruthRoute(e),i=[];for(;t;)i.push(t.url.join("/")),t=t.parent;return`/${i.filter(s=>s).reverse().join("/")}`}can(e){let t=this.getUrl(e);if(t===this.removeUrlBuffer)return!1;if(e.data&&typeof e.data.reuse=="boolean")return e.data.reuse;if(this.mode!==a.URL){let i=this.getMenu(t);if(!i)return!1;if(this.mode===a.Menu){if(i.reuse===!1)return!1}else if(!i.reuse||i.reuse!==!0)return!1;return!0}return!this.isExclude(t)}isExclude(e){return this.excludes.findIndex(t=>t.test(e))!==-1}refresh(e){this._cachedChange.next({active:"refresh",data:e})}destroy(e){e&&e.componentRef&&e.componentRef.destroy&&e.componentRef.destroy()}di(...e){}constructor(){this.cached==null&&(this.cached={list:[],title:{},closable:{}})}init(){this.initScroll(),this._inited=!0,this.loadState()}loadState(){this.storageState&&(this.cached.list=this.stateSrv.get(this.stateKey).map(e=>_(g({},e),{title:{text:e.title},url:e.url,position:e.position})),this._cachedChange.next({active:"loadState"}))}getMenu(e){let t=this.menuService.getPathByUrl(e);return!t||t.length===0?null:t.pop()}runHook(e,t,i="init"){if(typeof t=="number"&&(t=this.cached.list[t]._handle?.componentRef),t==null||!t.instance)return;let n=t.instance,s=n[e];typeof s=="function"&&(e==="_onReuseInit"?s.call(n,i):s.call(n))}hasInValidRoute(e){return!e.routeConfig||!!e.routeConfig.loadChildren||!!e.routeConfig.children}shouldDetach(e){return this.hasInValidRoute(e)?!1:(this.di("#shouldDetach",this.can(e),this.getUrl(e)),this.can(e))}saveCache(e,t,i){let n=this.getTruthRoute(e),s=this.getUrl(e),o=this.index(s),c={title:this.getTitle(s,n),url:s,closable:this.getClosable(s,e),_snapshot:e,_handle:t};if(o<0){if(this.items.splice(i??this.items.length,0,c),this.count>this._max){let d=this.items.findIndex(u=>u.url!==s&&u.closable);if(d!==-1){let u=this.items[d];this.remove(d,!1),m(1).pipe(f(1)).subscribe(()=>this._cachedChange.next({active:"close",url:u.url,list:this.cached.list}))}}}else this.items[o]=c}store(e,t){let i=this.getUrl(e);t!=null&&this.saveCache(e,t);let n=this.cached.list,s={title:this.getTitle(i,e),closable:this.getClosable(i,e),position:this.getKeepingScroll(i,e)?this.positionBuffer[i]:null,url:i,_snapshot:e,_handle:t},o=this.index(i),c=n[o]?._handle?.componentRef;t==null&&c!=null&&m(100).pipe(f(1)).subscribe(()=>this.runHook("_onReuseInit",c)),n[o]=s,this.removeUrlBuffer=null,this.di("#store","[override]",i),t&&t.componentRef&&this.runHook("_onReuseDestroy",t.componentRef),this._cachedChange.next({active:"override",item:s,list:n})}shouldAttach(e){if(this.hasInValidRoute(e))return!1;let t=this.getUrl(e),i=this.get(t),n=!!(i&&i._handle);return this.di("#shouldAttach",n,t),n||this._cachedChange.next({active:"add",url:t,list:this.cached.list}),n}retrieve(e){if(this.hasInValidRoute(e))return null;let t=this.getUrl(e),i=this.get(t),n=i&&i._handle||null;return this.di("#retrieve",t,n),n}shouldReuseRoute(e,t){let i=e.routeConfig===t.routeConfig;if(!i)return!1;let n=e.routeConfig&&e.routeConfig.path||"";return n.length>0&&~n.indexOf(":")&&(this.routeParamMatchMode==="strict"?i=this.getUrl(e)===this.getUrl(t):i=n===(t.routeConfig&&t.routeConfig.path||"")),this.di("====================="),this.di("#shouldReuseRoute",i,`${this.getUrl(t)}=>${this.getUrl(e)}`,e,t),i}getKeepingScroll(e,t){if(t&&t.data&&typeof t.data.keepingScroll=="boolean")return t.data.keepingScroll;let i=this.mode!==a.URL?this.getMenu(e):null;return i&&typeof i.keepingScroll=="boolean"?i.keepingScroll:this.keepingScroll}get isDisabledInRouter(){return this.injector.get(y,{}).scrollPositionRestoration==="disabled"}get ss(){return this.injector.get(R)}initScroll(){this._router$&&this._router$.unsubscribe(),this._router$=this.injector.get(p).events.subscribe(e=>{if(e instanceof x){let t=this.curUrl;this.getKeepingScroll(t,this.getTruthRoute(this.snapshot))?this.positionBuffer[t]=this.ss.getScrollPosition(this.keepingScrollContainer):delete this.positionBuffer[t]}else if(e instanceof T){let t=this.curUrl,i=this.get(t);i&&i.position&&this.getKeepingScroll(t,this.getTruthRoute(this.snapshot))&&(this.isDisabledInRouter?this.ss.scrollToPosition(this.keepingScrollContainer,i.position):setTimeout(()=>this.ss.scrollToPosition(this.keepingScrollContainer,i.position),1))}})}ngOnDestroy(){let{_cachedChange:e,_router$:t}=this;this.clear(),this.cached.list=[],e.complete(),t&&t.unsubscribe()}static \u0275fac=function(t){return new(t||r)};static \u0275prov=b({token:r,factory:r.\u0275fac})}return r})();export{$e as a};
