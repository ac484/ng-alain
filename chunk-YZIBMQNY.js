import{a as ut,b as On,c as Vn}from"./chunk-J3EG3STT.js";import{a as je,c as Ge,d as Qe,h as oe,i as qe}from"./chunk-UDTB74T4.js";import{a as Nn,b as In,c as Bn}from"./chunk-DPHAQU4H.js";import{a as ne,g as rt,i as Z,j as ie,k as bt,n as at}from"./chunk-CVWZRLFH.js";import"./chunk-LGQCUHVE.js";import"./chunk-VAGS5EVQ.js";import{a as En,b as Pn}from"./chunk-N3HEJK33.js";import{a as un,b as dn,c as Ot}from"./chunk-TDRF6KRZ.js";import{d as We,f as $e,i as He,j as Pt,k as Nt}from"./chunk-5PWQKJFE.js";import"./chunk-NY7H4EKY.js";import{a as Dn,b as Tn,c as Fn,d as kn,e as Mn}from"./chunk-VUMOBTWS.js";import{a as wn,b as bn}from"./chunk-D646ULWR.js";import"./chunk-3RWD3HET.js";import{f as pt,k as mt}from"./chunk-B3W3FN3D.js";import{c as fn,d as gn,f as Cn,h as _n,j as hn,k as zn,l as yn,n as vn}from"./chunk-NYUTY3O4.js";import"./chunk-RFN2QM7O.js";import"./chunk-6USQTNTQ.js";import{a as an,c as sn,f as cn,g as ln,i as pn,j as mn}from"./chunk-MPSNF54G.js";import{a as on,b as rn}from"./chunk-Z43QPZ6Y.js";import"./chunk-FO23PQCE.js";import{a as Sn,b as xn}from"./chunk-3GD5IINY.js";import{d as st}from"./chunk-BDGDCHBQ.js";import"./chunk-N3ASW3AC.js";import"./chunk-T7EVMTMV.js";import"./chunk-G3VEBS7K.js";import"./chunk-P43R2PK7.js";import{d as ct,e as re,g as lt,h as Xe,m as It,n as Ze,o as Je,q as Ke,t as tn,x as en,y as Bt,z as nn}from"./chunk-TILQNZML.js";import"./chunk-LPDDJ3TV.js";import"./chunk-ECUEXY2D.js";import"./chunk-AFUA6SNM.js";import"./chunk-7OUOMJSL.js";import{t as ee}from"./chunk-NK4AO4BP.js";import"./chunk-F62RTV2J.js";import{d as Ye}from"./chunk-7FRFMFPD.js";import"./chunk-CB6IRRWZ.js";import"./chunk-QLO4SMLE.js";import"./chunk-C7IJ32K6.js";import{h as Q,q,s as Y,t as X}from"./chunk-ZP3JRH3N.js";import{Nc as B,Oc as O,Pc as Ue,a as Mt,aa as te,e as Ve,ea as Ae,f as Le,ga as Re,o as Et}from"./chunk-YKU44AMC.js";import{o as Ft,p as kt,q as Kt,x as Oe,y as ot}from"./chunk-M6U45NYK.js";import{Aa as d,Ac as De,Ba as f,Cc as H,Dc as j,Dd as Zt,Ec as G,Fa as _e,Fb as T,Fc as Yt,Ga as Qt,Gb as ye,Hc as Te,Hd as Jt,Ic as L,Ka as b,Kc as zt,Lb as D,Mc as Fe,Nc as m,Ob as V,Oc as K,Pb as ve,Pc as F,R as fe,Ra as he,Sc as yt,Tc as vt,Uc as wt,_b as N,ac as I,b as me,bd as ke,cc as we,dc as Dt,dd as Me,ec as Tt,fc as l,g as ue,ga as ge,gc as a,gd as Ee,hc as s,ic as h,jd as Pe,kd as A,mc as be,nb as ze,nc as Se,oa as xt,oc as qt,pa as Ce,pc as S,pd as R,q as de,qd as Ne,r as jt,rd as Ie,sa as Gt,sb as c,ta as y,ud as Be,vc as g,vd as W,yb as J,yc as p,yd as Xt,zc as xe}from"./chunk-MUKALFIJ.js";import{a as M,b as P,g as Ht,i as _}from"./chunk-57BLH6QZ.js";function Un(o,e){}function Hn(o,e){if(o&1&&(a(0,"div",2),D(1,Un,0,0,"ng-template",4),s()),o&2){let t=p(2);c(),l("ngTemplateOutlet",t.nzIcon)}}function jn(o,e){if(o&1&&(be(0),m(1),Se()),o&2){let t=p(3);c(),F(" ",t.nzDescription," ")}}function Gn(o,e){if(o&1&&(a(0,"div",3),D(1,jn,2,1,"ng-container",5),s()),o&2){let t=p(2);c(),l("nzStringTemplateOutlet",t.nzDescription)}}function Qn(o,e){if(o&1&&(N(0,Hn,2,1,"div",2),N(1,Gn,2,1,"div",3)),o&2){let t=p();I(t.nzIcon?0:-1),c(),I(t.nzDescription&&t.nzShape==="square"?1:-1)}}function qn(o,e){o&1&&(a(0,"div",2),h(1,"nz-icon",6),s())}function Yn(o,e){if(o&1){let t=S();a(0,"a",2),g("click",function(){d(t);let i=p();return f(i.nzOnClick.emit(!0))}),h(1,"nz-float-button-content",3),s()}if(o&2){let t=p();zt("ant-float-btn-default",t.nzType==="default"),l("target",t.nzTarget)("href",t.nzHref,ze)("nzType",t.nzType),c(),l("nzIcon",t.nzIcon)("nzDescription",t.nzDescription)("nzShape",t.nzShape)}}function Xn(o,e){if(o&1){let t=S();a(0,"button",4),g("click",function(){d(t);let i=p();return f(i.nzOnClick.emit(!0))}),h(1,"nz-float-button-content",3),s()}if(o&2){let t=p();zt("ant-float-btn-default",t.nzType==="default"),l("nzType",t.nzType),c(),l("nzIcon",t.nzIcon)("nzDescription",t.nzDescription)("nzShape",t.nzShape)}}var Zn=["backTop"];function Jn(o,e){o&1&&h(0,"nz-icon",3)}var Kn=["*"];function ti(o,e){o&1&&qt(0)}function ei(o,e){if(o&1&&D(0,ti,1,0,"ng-container",2),o&2){p();let t=L(3);l("ngTemplateOutlet",t)}}function ni(o,e){o&1&&qt(0)}function ii(o,e){if(o&1&&(a(0,"div",3),D(1,ni,1,0,"ng-container",2),s()),o&2){p(2);let t=L(3);l("@fadeMotion",void 0),c(),l("ngTemplateOutlet",t)}}function oi(o,e){if(o&1){let t=S();N(0,ii,2,2,"div",3),a(1,"nz-float-button",4),g("nzOnClick",function(){d(t);let i=p();return f(i.open()?i.clickCloseMenu():i.clickOpenMenu())})("mouseover",function(){d(t);let i=p();return f(i.hoverOpenMenu())}),s()}if(o&2){let t=p(),n=L(5);I(t.open()?0:-1),c(),l("nzType",t.nzType())("nzIcon",t.open()?n:t.nzIcon())("nzShape",t.nzShape())("nzDescription",t.open()?null:t.nzDescription())}}function ri(o,e){o&1&&De(0)}function ai(o,e){o&1&&h(0,"nz-icon",5)}var Ln=(()=>{class o{nzIcon=null;nzDescription=null;nzShape="circle";static \u0275fac=function(n){return new(n||o)};static \u0275cmp=T({type:o,selectors:[["nz-float-button-content"]],inputs:{nzIcon:"nzIcon",nzDescription:"nzDescription",nzShape:"nzShape"},exportAs:["nzFloatButtonContent"],decls:4,vars:1,consts:[[1,"ant-float-btn-body"],[1,"ant-float-btn-content"],[1,"ant-float-btn-icon"],[1,"ant-float-btn-description"],[3,"ngTemplateOutlet"],[4,"nzStringTemplateOutlet"],["nzType","file-text","nzTheme","outline"]],template:function(n,i){n&1&&(a(0,"div",0)(1,"div",1),N(2,Qn,2,2)(3,qn,2,0,"div",2),s()()),n&2&&(c(2),I(i.nzDescription||i.nzIcon?2:3))},dependencies:[O,B,Kt,Ue],encapsulation:2,changeDetection:0})}return o})(),tt=(()=>{class o{directionality=y(Et);cdr=y(Zt);destroyRef=y(Qt);nzHref=null;nzTarget=null;nzType="default";nzShape="circle";nzIcon=null;nzDescription=null;nzOnClick=new V;dir="ltr";constructor(){this.dir=this.directionality.value}ngOnInit(){this.directionality.change?.pipe(Mt(this.destroyRef)).subscribe(t=>{this.dir=t,this.cdr.detectChanges()}),this.dir=this.directionality.value}static \u0275fac=function(n){return new(n||o)};static \u0275cmp=T({type:o,selectors:[["nz-float-button"]],hostAttrs:[1,"ant-float-btn"],hostVars:6,hostBindings:function(n,i){n&2&&zt("ant-float-btn-circle",i.nzShape==="circle")("ant-float-btn-square",i.nzShape==="square")("ant-float-btn-rtl",i.dir==="rtl")},inputs:{nzHref:"nzHref",nzTarget:"nzTarget",nzType:"nzType",nzShape:"nzShape",nzIcon:"nzIcon",nzDescription:"nzDescription"},outputs:{nzOnClick:"nzOnClick"},exportAs:["nzFloatButton"],decls:2,vars:1,consts:[["nz-button","",1,"ant-float-btn-inner",3,"target","href","nzType","ant-float-btn-default"],["nz-button","",1,"ant-float-btn-inner",3,"nzType","ant-float-btn-default"],["nz-button","",1,"ant-float-btn-inner",3,"click","target","href","nzType"],[3,"nzIcon","nzDescription","nzShape"],["nz-button","",1,"ant-float-btn-inner",3,"click","nzType"]],template:function(n,i){n&1&&N(0,Yn,2,8,"a",0)(1,Xn,2,6,"button",1),n&2&&I(i.nzHref?0:1)},dependencies:[X,Y,Q,q,Ln],encapsulation:2,changeDetection:0})}return o})(),si="backTop",ci=Le({passive:!0}),ae=(()=>{var n;let o,e=[],t=[];return n=class{nzConfigService=y(Ae);scrollSrv=y(Ye);platform=y(Ve);ngZone=y(ve);cdr=y(Zt);directionality=y(Et);destroyRef=y(Qt);_nzModuleName=si;scrollListenerDestroy$=new ue;target=null;visible=!1;dir="ltr";nzHref=null;nzType="default";nzShape="circle";nzIcon=null;nzDescription=null;nzTemplate;nzVisibilityHeight=jt(this,e,400);nzTarget=jt(this,t);nzDuration=450;nzOnClick=new V;set backTop(r){r&&(this.backTopClickSubscription.unsubscribe(),this.backTopClickSubscription=te(r.nativeElement,"click").pipe(Mt(this.destroyRef)).subscribe(()=>{this.scrollSrv.scrollTo(this.getTarget(),0,{duration:this.nzDuration}),this.nzOnClick.observers.length&&this.ngZone.run(()=>this.nzOnClick.emit(!0))}))}doc=y(_e);backTopClickSubscription=me.EMPTY;constructor(){this.destroyRef.onDestroy(()=>{this.scrollListenerDestroy$.next(),this.scrollListenerDestroy$.complete()})}ngOnInit(){this.registerScrollEvent(),this.dir=this.directionality.value,this.directionality.change?.pipe(Mt(this.destroyRef)).subscribe(r=>{this.dir=r,this.cdr.detectChanges()})}getTarget(){return this.target||window}handleScroll(){this.visible!==this.scrollSrv.getScroll(this.getTarget())>this.nzVisibilityHeight&&(this.visible=!this.visible,this.cdr.detectChanges())}registerScrollEvent(){this.platform.isBrowser&&(this.scrollListenerDestroy$.next(),this.handleScroll(),te(this.getTarget(),"scroll",ci).pipe(fe(50),ge(this.scrollListenerDestroy$)).subscribe(()=>this.handleScroll()))}detectChanges(){this.cdr.detectChanges()}ngOnChanges(r){let{nzTarget:u}=r;u&&(this.target=typeof this.nzTarget=="string"?this.doc.querySelector(this.nzTarget):this.nzTarget,this.registerScrollEvent())}},(()=>{let r=typeof Symbol=="function"&&Symbol.metadata?Object.create(null):void 0;o=[Re()],de(null,null,o,{kind:"field",name:"nzVisibilityHeight",static:!1,private:!1,access:{has:u=>"nzVisibilityHeight"in u,get:u=>u.nzVisibilityHeight,set:(u,C)=>{u.nzVisibilityHeight=C}},metadata:r},e,t),r&&Object.defineProperty(n,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:r})})(),Ht(n,"\u0275fac",function(u){return new(u||n)}),Ht(n,"\u0275cmp",T({type:n,selectors:[["nz-float-button-top"]],viewQuery:function(u,C){if(u&1&&H(Zn,5),u&2){let z;j(z=G())&&(C.backTop=z.first)}},hostAttrs:[1,"ant-float-btn","ant-float-btn-top"],hostVars:8,hostBindings:function(u,C){u&2&&zt("ant-float-btn-circle",C.nzShape==="circle")("ant-float-btn-hidden",!C.visible)("ant-float-btn-square",C.nzShape==="square")("ant-float-btn-rtl",C.dir==="rtl")},inputs:{nzHref:"nzHref",nzType:"nzType",nzShape:"nzShape",nzIcon:"nzIcon",nzDescription:"nzDescription",nzTemplate:"nzTemplate",nzVisibilityHeight:[2,"nzVisibilityHeight","nzVisibilityHeight",Jt],nzTarget:"nzTarget",nzDuration:[2,"nzDuration","nzDuration",Jt]},outputs:{nzOnClick:"nzOnClick"},exportAs:["nzFloatButtonTop"],features:[he],decls:5,vars:6,consts:[["backTop",""],["top",""],[3,"nzIcon","nzDescription","nzHref","nzType","nzShape"],["nzType","vertical-align-top","nzTheme","outline"]],template:function(u,C){if(u&1&&(a(0,"div",null,0),h(2,"nz-float-button",2),D(3,Jn,1,0,"ng-template",null,1,A),s()),u&2){let z=L(4);l("@fadeMotion",void 0),c(2),l("nzIcon",C.nzIcon||z)("nzDescription",C.nzDescription)("nzHref",C.nzHref)("nzType",C.nzType)("nzShape",C.nzShape)}},dependencies:[tt,O,B],encapsulation:2,data:{animation:[ee]},changeDetection:0})),n})(),pe=(()=>{class o{nzFloatButtonComponents=Xt(tt);nzFloatButtonTopComponents=Xt(ae);nzHref=W(null);nzTarget=W(null);nzType=W("default");nzIcon=W(null);nzDescription=W(null);nzShape=W("circle");nzTrigger=W(null);nzOpen=W(null);nzPlacement=W("top");nzOnOpenChange=Be();dir=y(Et).valueSignal;open=Ie(()=>!!this.nzOpen());isMenuMode=R(()=>!!this.nzTrigger()&&["click","hover"].includes(this.nzTrigger()));isControlledMode=R(()=>this.nzOpen()!==null);class=R(()=>{let t=this.nzShape(),n=this.dir(),i=["ant-float-btn-group",this.generateClass(t)];return this.isMenuMode()?i.push(this.generateClass(this.nzPlacement())):i.push(this.generateClass(`${t}-shadow`)),n==="rtl"&&i.push(this.generateClass(n)),i});constructor(){Ne(()=>{this.nzFloatButtonComponents()&&this.nzFloatButtonComponents().forEach(t=>{t.nzShape=this.nzShape()}),this.nzFloatButtonTopComponents()&&this.nzFloatButtonTopComponents().forEach(t=>{t.nzShape=this.nzShape(),t.detectChanges()})})}clickOpenMenu(){this.handleEvent("click",!0)}hoverOpenMenu(){this.handleEvent("hover",!0)}clickCloseMenu(){this.handleEvent("click",!1)}hoverCloseMenu(){this.handleEvent("hover",!1)}handleEvent(t,n){this.nzTrigger()!==t||this.isControlledMode()||this.open()===n||(this.open.set(n),this.nzOnOpenChange.emit(n))}generateClass(t){return`ant-float-btn-group-${t}`}static \u0275fac=function(n){return new(n||o)};static \u0275cmp=T({type:o,selectors:[["nz-float-button-group"]],contentQueries:function(n,i,r){n&1&&(Yt(r,i.nzFloatButtonComponents,tt,4),Yt(r,i.nzFloatButtonTopComponents,ae,4)),n&2&&Te(2)},hostVars:2,hostBindings:function(n,i){n&1&&g("mouseleave",function(){return i.hoverCloseMenu()}),n&2&&Fe(i.class())},inputs:{nzHref:[1,"nzHref"],nzTarget:[1,"nzTarget"],nzType:[1,"nzType"],nzIcon:[1,"nzIcon"],nzDescription:[1,"nzDescription"],nzShape:[1,"nzShape"],nzTrigger:[1,"nzTrigger"],nzOpen:[1,"nzOpen"],nzPlacement:[1,"nzPlacement"]},outputs:{nzOnOpenChange:"nzOnOpenChange"},exportAs:["nzFloatButtonGroup"],ngContentSelectors:Kn,decls:6,vars:1,consts:[["menu",""],["close",""],[4,"ngTemplateOutlet"],[1,"ant-float-btn-group-wrap"],[1,"ant-float-btn-group-trigger",3,"nzOnClick","mouseover","nzType","nzIcon","nzShape","nzDescription"],["nzType","close","nzTheme","outline"]],template:function(n,i){n&1&&(xe(),N(0,ei,1,1,"ng-container")(1,oi,2,5),D(2,ri,1,0,"ng-template",null,0,A)(4,ai,1,0,"ng-template",null,1,A)),n&2&&I(i.isMenuMode()?1:0)},dependencies:[tt,O,B,Kt],encapsulation:2,data:{animation:[ee]},changeDetection:0})}return o})(),An=(()=>{class o{static \u0275fac=function(n){return new(n||o)};static \u0275mod=ye({type:o});static \u0275inj=Ce({imports:[tt,pe,ae,Ln]})}return o})();var pi=["upIcon"],mi=["downIcon"],ui=["leftIcon"],di=["rightIcon"],fi=["commentIcon"],gi=(o,e)=>({x:o,y:e});function Ci(o,e){o&1&&h(0,"nz-icon",8)}function _i(o,e){o&1&&h(0,"nz-icon",9)}function hi(o,e){o&1&&h(0,"nz-icon",10)}function zi(o,e){o&1&&h(0,"nz-icon",11)}function yi(o,e){o&1&&h(0,"nz-icon",12)}var dt=class dt{constructor(){this.dragX=0;this.dragY=0;this.smartPlacement="top";this.currentX=0;this.currentY=0;this.onAction=new V}get currentIcon(){return{top:this.upIcon,bottom:this.downIcon,left:this.leftIcon,right:this.rightIcon}[this.smartPlacement]}onDragMove(e){let t=e.source.element.nativeElement.getBoundingClientRect();this.currentX=t.left,this.currentY=t.top,this.smartPlacement=this.calculateSmartPlacement(this.currentX,this.currentY)}onDragEnd(e){this.dragX=e.source.getFreeDragPosition().x,this.dragY=e.source.getFreeDragPosition().y,this.smartPlacement=this.calculateSmartPlacement(this.currentX,this.currentY)}calculateSmartPlacement(e,t){let n=window.innerWidth,i=window.innerHeight,r=56,u=e+r/2,C=t+r/2,z=n/2,v=i/2,w=u-z,x=C-v;return Math.abs(w)>Math.abs(x)?w>0?"left":"right":x>0?"top":"bottom"}openChange(e){}};dt.\u0275fac=function(t){return new(t||dt)},dt.\u0275cmp=T({type:dt,selectors:[["app-fab"]],viewQuery:function(t,n){if(t&1&&(H(pi,7),H(mi,7),H(ui,7),H(di,7),H(fi,7)),t&2){let i;j(i=G())&&(n.upIcon=i.first),j(i=G())&&(n.downIcon=i.first),j(i=G())&&(n.leftIcon=i.first),j(i=G())&&(n.rightIcon=i.first),j(i=G())&&(n.commentIcon=i.first)}},outputs:{onAction:"onAction"},decls:13,vars:7,consts:[["upIcon",""],["downIcon",""],["leftIcon",""],["rightIcon",""],["commentIcon",""],["cdkDrag","",1,"fab-drag-anchor",3,"cdkDragEnded","cdkDragMoved","cdkDragFreeDragPosition"],["nzType","primary","nzTrigger","click",3,"nzOnOpenChange","nzIcon","nzPlacement"],[3,"click","nzIcon"],["nzType","up","nzTheme","outline"],["nzType","down","nzTheme","outline"],["nzType","left","nzTheme","outline"],["nzType","right","nzTheme","outline"],["nzType","plus","nzTheme","outline"]],template:function(t,n){if(t&1){let i=S();a(0,"div",5),g("cdkDragEnded",function(u){return d(i),f(n.onDragEnd(u))})("cdkDragMoved",function(u){return d(i),f(n.onDragMove(u))}),a(1,"nz-float-button-group",6),g("nzOnOpenChange",function(u){return d(i),f(n.openChange(u))}),a(2,"nz-float-button",7),g("click",function(){return d(i),f(n.onAction.emit("add"))}),s()(),D(3,Ci,1,0,"ng-template",null,0,A)(5,_i,1,0,"ng-template",null,1,A)(7,hi,1,0,"ng-template",null,2,A)(9,zi,1,0,"ng-template",null,3,A)(11,yi,1,0,"ng-template",null,4,A),s()}if(t&2){let i=L(12);l("cdkDragFreeDragPosition",Me(4,gi,n.dragX,n.dragY)),c(),l("nzIcon",n.currentIcon)("nzPlacement",n.smartPlacement),c(),l("nzIcon",i)}},dependencies:[An,tt,pe,O,B,$e,We],styles:[".fab-drag-anchor[_ngcontent-%COMP%]{position:fixed;z-index:1000;right:32px;bottom:32px;cursor:grab;-webkit-user-select:none;user-select:none}.fab-drag-anchor[_ngcontent-%COMP%]:active{cursor:grabbing}nz-float-button-group[_ngcontent-%COMP%]{position:absolute}"]});var Lt=dt;var nt=class nt{constructor(e,t){this.hubCrud=e;this.workflowService=t;this.collectionName="hub_contract_payments"}listByContract(e){return _(this,null,function*(){let t=Z(this.hubCrud.firestoreInstance,"hub_contract",e),n=yield ie(t);return n.exists()?n.data().payments||[]:[]})}add(e,t,n="",i){return _(this,null,function*(){let r=yield this.workflowService.getTemplateForClient(i),u=r?yield this.initializeWorkflow(r.key):yield this.initializeWorkflow(yield this.createDefaultWorkflowTemplate(i)),C={contractId:e,amount:t,status:"draft",workflowId:r?r.key:"",steps:u,attachments:[],remark:n,createdAt:new Date,updatedAt:new Date},z=Z(this.hubCrud.firestoreInstance,"hub_contract",e);return yield at(this.hubCrud.firestoreInstance,v=>_(this,null,function*(){let w=yield v.get(z);if(!w.exists())throw new Error("Contract not found");let k=[...w.data().payments||[],C];v.update(z,{payments:k})})),"local-array-id"})}update(e,t){return _(this,null,function*(){let n=rt(this.hubCrud.firestoreInstance,"hub_contract"),i=yield bt(n);for(let r of i.docs){let C=r.data().payments?.findIndex(z=>z.key===e);if(C!==void 0&&C>=0){let z=Z(this.hubCrud.firestoreInstance,"hub_contract",r.id);yield at(this.hubCrud.firestoreInstance,v=>_(this,null,function*(){let w=yield v.get(z);if(!w.exists())throw new Error("Contract not found");let k=[...w.data().payments];k[C]=P(M(M({},k[C]),t),{updatedAt:new Date}),v.update(z,{payments:k})}));return}}throw new Error(`Payment not found: ${e}`)})}delete(e){return _(this,null,function*(){let t=rt(this.hubCrud.firestoreInstance,"hub_contract"),n=yield bt(t);for(let i of n.docs){let u=i.data().payments?.findIndex(C=>C.key===e);if(u!==void 0&&u>=0){let C=Z(this.hubCrud.firestoreInstance,"hub_contract",i.id);yield at(this.hubCrud.firestoreInstance,z=>_(this,null,function*(){let v=yield z.get(C);if(!v.exists())throw new Error("Contract not found");let x=v.data().payments.filter((k,$)=>$!==u);z.update(C,{payments:x})}));return}}throw new Error(`Payment not found: ${e}`)})}submitPayment(e){return _(this,null,function*(){let t=rt(this.hubCrud.firestoreInstance,"hub_contract"),n=yield bt(t);for(let i of n.docs){let u=i.data().payments?.findIndex(C=>C.key===e);if(u!==void 0&&u>=0){let C=Z(this.hubCrud.firestoreInstance,"hub_contract",i.id);yield at(this.hubCrud.firestoreInstance,z=>_(this,null,function*(){let v=yield z.get(C);if(!v.exists())throw new Error("Contract not found");let w=v.data(),x=w.payments[u];if(x.status!=="draft")throw new Error(`Payment cannot be submitted. Current status: ${x.status}`);let k=[...x.steps];k.length>0&&(k[0]=P(M({},k[0]),{status:"pending",updatedAt:new Date}));let $=[...w.payments];$[u]=P(M({},x),{status:"submitted",steps:k,updatedAt:new Date}),z.update(C,{payments:$})}));return}}throw new Error(`Payment not found: ${e}`)})}initializeWorkflow(e){return _(this,null,function*(){let t=rt(this.hubCrud.firestoreInstance,"hub_workflow_definitions"),n=Z(t,e),i=yield ie(n);if(!i.exists())throw new Error(`Workflow template not found: ${e}`);return M({key:i.id},i.data()).steps.map((u,C)=>({name:u.name,status:"waiting",approver:u.approver,comment:"",updatedAt:new Date}))})}advanceWorkflow(e,t,n,i=""){return _(this,null,function*(){let r=rt(this.hubCrud.firestoreInstance,"hub_contract"),u=yield bt(r);for(let C of u.docs){let v=C.data().payments?.findIndex(w=>w.key===e);if(v!==void 0&&v>=0){let w=Z(this.hubCrud.firestoreInstance,"hub_contract",C.id);yield at(this.hubCrud.firestoreInstance,x=>_(this,null,function*(){let k=yield x.get(w);if(!k.exists())throw new Error("Contract not found");let $=k.data(),St=$.payments[v],E=[...St.steps];if(t<0||t>=E.length)throw new Error(`Invalid step index: ${t}`);if(E[t].status!=="pending")throw new Error(`Step ${t} is not in pending status`);if(n)if(E[t]=P(M({},E[t]),{status:"done",comment:i,updatedAt:new Date}),t+1<E.length){E[t+1]=P(M({},E[t+1]),{status:"pending",updatedAt:new Date});let U=[...$.payments];U[v]=P(M({},St),{steps:E,status:"reviewing",updatedAt:new Date}),x.update(w,{payments:U})}else{let U=[...$.payments];U[v]=P(M({},St),{steps:E,status:"approved",updatedAt:new Date}),x.update(w,{payments:U})}else{E[t]=P(M({},E[t]),{status:"rejected",comment:i,updatedAt:new Date});let U=[...$.payments];U[v]=P(M({},St),{steps:E,status:"rejected",updatedAt:new Date}),x.update(w,{payments:U})}}));return}}throw new Error(`Payment not found: ${e}`)})}createDefaultWorkflowTemplate(e){return _(this,null,function*(){let t={name:`${e} \u9810\u8A2D\u5BE9\u6279\u6D41\u7A0B`,clientId:e,isActive:!0,steps:[{name:"\u4E3B\u7BA1\u5BE9\u6838",approver:"supervisor",order:1},{name:"\u8CA1\u52D9\u5BE9\u6838",approver:"finance",order:2}],createdAt:ne(),updatedAt:ne()};return yield this.workflowService.createTemplate(t)})}};nt.\u0275fac=function(t){return new(t||nt)(Gt(ut),Gt(On))},nt.\u0275prov=xt({token:nt,factory:nt.\u0275fac,providedIn:"root"});var ft=nt;function xi(o,e){if(o&1&&h(0,"nz-step",8),o&2){let t=e.$implicit,n=p();l("nzTitle",t.name)("nzDescription",n.getStepDescription(t))("nzIcon",n.getStepIcon(t.status))}}function Di(o,e){if(o&1){let t=S();a(0,"div",9)(1,"button",10),g("click",function(){d(t);let i=p();return f(i.showApprovalModal(!0))}),h(2,"span",11),m(3," \u6838\u51C6 "),s(),a(4,"button",12),g("click",function(){d(t);let i=p();return f(i.showApprovalModal(!1))}),h(5,"span",13),m(6," \u62D2\u7D55 "),s()()}if(o&2){let t=p();c(),l("nzLoading",t.isProcessing()),c(3),l("nzLoading",t.isProcessing())}}function Ti(o,e){if(o&1&&(a(0,"div",14)(1,"span",15),h(2,"span",16),m(3),s()()),o&2){let t,n=p();c(3),F(" \u7B49\u5F85 ",(t=n.getCurrentStep())==null?null:t.approver," \u5BE9\u6279 ")}}var gt=class gt{constructor(){this.currentUser="current-user";this.workflowUpdated=new V;this.paymentService=y(ft);this.hubCrud=y(ut);this.message=y(st);this.isProcessing=b(!1);this.showModal=b(!1);this.isApproving=b(!1);this.approvalComment=b("");this.currentStepIndex=R(()=>{let e=this.payment.steps.findIndex(t=>t.status==="pending");return e>=0?e:this.payment.steps.length});this.modalTitle=R(()=>this.isApproving()?"\u78BA\u8A8D\u6838\u51C6":"\u78BA\u8A8D\u62D2\u7D55");this.modalMessage=R(()=>{let e=this.getCurrentStep();return`\u78BA\u5B9A\u8981${this.isApproving()?"\u6838\u51C6":"\u62D2\u7D55"}\u300C${e?.name}\u300D\u6B65\u9A5F\u55CE\uFF1F`})}getCurrentStep(){let e=this.currentStepIndex();return e<this.payment.steps.length?this.payment.steps[e]:null}canCurrentUserApprove(){let e=this.getCurrentStep();return e?.status==="pending"&&e?.approver===this.currentUser}getStepsStatus(){return this.payment.status==="approved"?"finish":this.payment.status==="rejected"?"error":"process"}getStepIcon(e){switch(e){case"done":return"check";case"rejected":return"close";case"pending":return"clock-circle";case"waiting":return"ellipsis";default:return"ellipsis"}}getStepDescription(e){switch(e.status){case"done":return e.comment||"\u5DF2\u6838\u51C6";case"rejected":return e.comment||"\u5DF2\u62D2\u7D55";case"pending":return"\u5F85\u5BE9\u6279";case"waiting":return"\u7B49\u5F85\u4E2D";default:return""}}showApprovalModal(e){this.isApproving.set(e),this.approvalComment.set(""),this.showModal.set(!0)}closeModal(){this.showModal.set(!1),this.approvalComment.set("")}onModalVisibleChange(e){this.showModal.set(e),e||this.approvalComment.set("")}handleApproval(){return _(this,null,function*(){if(!this.isProcessing()){this.isProcessing.set(!0);try{let e=this.currentStepIndex(),t=this.isApproving(),n=this.approvalComment();if(e<0||e>=this.payment.steps.length)throw new Error("Invalid workflow step");yield this.paymentService.advanceWorkflow(this.payment.key,e,t,n);let i=t?"\u6838\u51C6":"\u62D2\u7D55";this.message.success(`${i}\u6210\u529F`),this.closeModal(),this.workflowUpdated.emit()}catch(e){console.error("Workflow approval error:",e);let t=e instanceof Error?e.message:"\u64CD\u4F5C\u5931\u6557\uFF0C\u8ACB\u91CD\u8A66";this.message.error(t)}finally{this.isProcessing.set(!1)}}})}};gt.\u0275fac=function(t){return new(t||gt)},gt.\u0275cmp=T({type:gt,selectors:[["app-contract-workflow-steps"]],inputs:{payment:"payment",currentUser:"currentUser"},outputs:{workflowUpdated:"workflowUpdated"},decls:14,vars:12,consts:[[1,"workflow-steps-container"],["nzSize","small",3,"nzCurrent","nzStatus"],[3,"nzTitle","nzDescription","nzIcon",4,"ngFor","ngForOf"],[1,"workflow-actions",2,"margin-top","16px"],["class","approval-actions",4,"ngIf"],["class","step-info",4,"ngIf"],[3,"nzOnOk","nzOnCancel","nzVisibleChange","nzVisible","nzTitle","nzOkText","nzOkType","nzOkLoading"],["nz-input","","rows","3","placeholder","\u8ACB\u8F38\u5165\u5BE9\u6279\u610F\u898B\uFF08\u9078\u586B\uFF09",3,"ngModelChange","ngModel"],[3,"nzTitle","nzDescription","nzIcon"],[1,"approval-actions"],["nz-button","","nzType","primary","nzSize","small",3,"click","nzLoading"],["nz-icon","","nzType","check"],["nz-button","","nzDanger","","nzSize","small",2,"margin-left","8px",3,"click","nzLoading"],["nz-icon","","nzType","close"],[1,"step-info"],[1,"waiting-info"],["nz-icon","","nzType","clock-circle"]],template:function(t,n){t&1&&(a(0,"div",0)(1,"h4"),m(2,"\u5BE9\u6279\u6D41\u7A0B"),s(),a(3,"nz-steps",1),D(4,xi,1,3,"nz-step",2),s(),a(5,"div",3),D(6,Di,7,2,"div",4)(7,Ti,4,1,"div",5),s(),a(8,"nz-modal",6),g("nzOnOk",function(){return n.handleApproval()})("nzOnCancel",function(){return n.closeModal()})("nzVisibleChange",function(r){return n.onModalVisibleChange(r)}),a(9,"div")(10,"p"),m(11),s(),a(12,"textarea",7),g("ngModelChange",function(r){return n.approvalComment.set(r)}),m(13,"          "),s()()()()),t&2&&(c(3),l("nzCurrent",n.currentStepIndex())("nzStatus",n.getStepsStatus()),c(),l("ngForOf",n.payment.steps),c(2),l("ngIf",n.canCurrentUserApprove()),c(),l("ngIf",!n.canCurrentUserApprove()&&n.getCurrentStep()),c(),l("nzVisible",n.showModal())("nzTitle",n.modalTitle())("nzOkText",n.isApproving()?"\u78BA\u8A8D\u6838\u51C6":"\u78BA\u8A8D\u62D2\u7D55")("nzOkType",n.isApproving()?"primary":"default")("nzOkLoading",n.isProcessing()),c(3),K(n.modalMessage()),c(),l("ngModel",n.approvalComment()))},dependencies:[ot,Ft,kt,Bt,ct,lt,It,Bn,In,Nn,X,Y,Q,q,mt,pt,Nt,Pt,O,B,Ot],styles:[".workflow-steps-container[_ngcontent-%COMP%]{padding:16px;background-color:#fafafa;border-radius:6px;margin-top:12px}.workflow-steps-container[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%]{margin:0 0 16px;color:#262626;font-size:14px}.workflow-actions[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center}.approval-actions[_ngcontent-%COMP%]{display:flex;gap:8px}.waiting-info[_ngcontent-%COMP%]{color:#8c8c8c;font-size:12px}.waiting-info[_ngcontent-%COMP%]   span[nz-icon][_ngcontent-%COMP%]{margin-right:4px}"],changeDetection:0});var Rt=gt;var it=class it{constructor(){this.storage=y(je);this.message=y(st)}validateFile(e){if(!["image/jpeg","image/png","image/gif","application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"].includes(e.type))return this.message.error("\u4E0D\u652F\u63F4\u7684\u6587\u4EF6\u985E\u578B\uFF01\u53EA\u80FD\u4E0A\u50B3\u5716\u7247\u3001PDF\u6216Office\u6587\u6A94"),!1;let n=10*1024*1024;return e.size>n?(this.message.error("\u6587\u4EF6\u5927\u5C0F\u4E0D\u80FD\u8D85\u904E 10MB\uFF01"),!1):!0}uploadFile(e,t){return _(this,null,function*(){if(!this.validateFile(e))throw new Error("File validation failed");try{let i=`${Date.now()}_${e.name}`,r=`contract-payments/${t}/${i}`,u=oe(this.storage,r),C=yield qe(u,e);return yield Qe(C.ref)}catch(n){throw console.error("Upload error:",n),this.message.error("\u6587\u4EF6\u4E0A\u50B3\u5931\u6557"),n}})}deleteFile(e){return _(this,null,function*(){try{let t=oe(this.storage,e);yield Ge(t)}catch(t){throw console.error("Delete error:",t),this.message.error("\u6587\u4EF6\u522A\u9664\u5931\u6557"),t}})}getFileNameFromUrl(e){try{let t=e.split("/"),n=t[t.length-1];return decodeURIComponent(n.split("?")[0]).replace(/^\d+_/,"")}catch{return"Unknown File"}}getFileTypeIcon(e){switch(e.split(".").pop()?.toLowerCase()){case"pdf":return"file-pdf";case"doc":case"docx":return"file-word";case"xls":case"xlsx":return"file-excel";case"jpg":case"jpeg":case"png":case"gif":return"file-image";default:return"file"}}};it.\u0275fac=function(t){return new(t||it)},it.\u0275prov=xt({token:it,factory:it.\u0275fac,providedIn:"root"});var Wt=it;var Fi=()=>({showPreviewIcon:!0,showRemoveIcon:!0,showDownloadIcon:!0}),Ct=class Ct{constructor(e,t){this.fb=e;this.message=t;this.payment=null;this.contractId="";this.formSubmit=new V;this.formCancel=new V;this.isSubmitting=b(!1);this.editMode=R(()=>!!this.payment);this.fileList=b([]);this.uploading=b(!1);this.attachmentService=y(Wt);this.beforeUpload=e=>this.fileList().length>=5?(this.message.error("\u6700\u591A\u53EA\u80FD\u4E0A\u50B35\u500B\u6587\u4EF6\uFF01"),!1):this.attachmentService.validateFile(e);this.customUpload=e=>{this.uploading.set(!0),this.attachmentService.uploadFile(e.file,this.contractId||"temp").then(t=>{e.onSuccess(t,e.file),this.message.success(`${e.file.name} \u4E0A\u50B3\u6210\u529F`)}).catch(t=>{e.onError(t,e.file),this.message.error(`${e.file.name} \u4E0A\u50B3\u5931\u6557`)}).finally(()=>{this.uploading.set(!1)})};this.paymentForm=this.createForm()}ngOnInit(){this.payment&&this.populateForm()}createForm(){return this.fb.group({amount:[null,[re.required,re.min(.01)]],remark:[""],attachments:[[]]})}populateForm(){if(this.payment){this.paymentForm.patchValue({amount:this.payment.amount,remark:this.payment.remark,attachments:this.payment.attachments});let e=this.payment.attachments.map((t,n)=>({uid:`${n}`,name:this.attachmentService.getFileNameFromUrl(t),status:"done",url:t,size:0,type:""}));this.fileList.set(e)}}handleFileChange(e){let t=[...e.fileList];t=t.slice(-5),this.fileList.set(t);let n=t.filter(i=>i.status==="done").map(i=>i.response?i.response:i.url||"").filter(i=>i);this.paymentForm.patchValue({attachments:n})}onSubmit(){if(this.paymentForm.valid&&!this.isSubmitting()){this.isSubmitting.set(!0);let e={amount:this.paymentForm.value.amount,remark:this.paymentForm.value.remark||"",attachments:this.paymentForm.value.attachments||[]};this.formSubmit.emit(e),setTimeout(()=>this.isSubmitting.set(!1),1e3)}}onCancel(){this.formCancel.emit()}resetForm(){this.paymentForm.reset(),this.fileList.set([]),this.isSubmitting.set(!1)}};Ct.\u0275fac=function(t){return new(t||Ct)(J(en),J(st))},Ct.\u0275cmp=T({type:Ct,selectors:[["app-contract-payment-form"]],inputs:{payment:"payment",contractId:"contractId"},outputs:{formSubmit:"formSubmit",formCancel:"formCancel"},decls:29,vars:20,consts:[["nz-form","",3,"ngSubmit","formGroup"],["nzRequired","",3,"nzSpan"],["nzErrorTip","\u8ACB\u8F38\u5165\u6709\u6548\u7684\u4ED8\u6B3E\u91D1\u984D",3,"nzSpan"],["formControlName","amount","nzPlaceHolder","\u8ACB\u8F38\u5165\u4ED8\u6B3E\u91D1\u984D",2,"width","100%",3,"nzMin","nzStep"],[3,"nzSpan"],["nz-input","","formControlName","remark","rows","3","placeholder","\u8ACB\u8F38\u5165\u5099\u8A3B\u8AAA\u660E"],["nzMultiple","",3,"nzChange","nzFileList","nzBeforeUpload","nzCustomRequest","nzShowUploadList"],["nz-button","",3,"nzLoading"],["nz-icon","","nzType","upload"],[2,"margin-top","8px","color","#8c8c8c","font-size","12px"],[3,"nzOffset","nzSpan"],["nz-button","","nzType","primary","type","submit",3,"nzLoading","disabled"],["nz-button","","type","button",2,"margin-left","8px",3,"click"]],template:function(t,n){t&1&&(a(0,"form",0),g("ngSubmit",function(){return n.onSubmit()}),a(1,"nz-form-item")(2,"nz-form-label",1),m(3,"\u4ED8\u6B3E\u91D1\u984D"),s(),a(4,"nz-form-control",2),h(5,"nz-input-number",3),s()(),a(6,"nz-form-item")(7,"nz-form-label",4),m(8,"\u5099\u8A3B"),s(),a(9,"nz-form-control",4)(10,"textarea",5),m(11,"          "),s()()(),a(12,"nz-form-item")(13,"nz-form-label",4),m(14,"\u9644\u4EF6"),s(),a(15,"nz-form-control",4)(16,"nz-upload",6),g("nzChange",function(r){return n.handleFileChange(r)}),a(17,"button",7),h(18,"span",8),a(19,"span"),m(20,"\u4E0A\u50B3\u9644\u4EF6"),s()()(),a(21,"div",9),m(22," \u652F\u63F4\u5716\u7247\u3001PDF\u3001Word\u3001Excel\u6587\u4EF6\uFF0C\u55AE\u500B\u6587\u4EF6\u4E0D\u8D85\u904E10MB\uFF0C\u6700\u591A5\u500B\u6587\u4EF6 "),s()()(),a(23,"nz-form-item")(24,"nz-form-control",10)(25,"button",11),m(26),s(),a(27,"button",12),g("click",function(){return n.onCancel()}),m(28," \u53D6\u6D88 "),s()()()()),t&2&&(l("formGroup",n.paymentForm),c(2),l("nzSpan",6),c(2),l("nzSpan",18),c(),l("nzMin",.01)("nzStep",.01),c(2),l("nzSpan",6),c(2),l("nzSpan",18),c(4),l("nzSpan",6),c(2),l("nzSpan",18),c(),l("nzFileList",n.fileList())("nzBeforeUpload",n.beforeUpload)("nzCustomRequest",n.customUpload)("nzShowUploadList",ke(19,Fi)),c(),l("nzLoading",n.uploading()),c(7),l("nzOffset",6)("nzSpan",18),c(),l("nzLoading",n.isSubmitting())("disabled",!n.paymentForm.valid||n.isSubmitting()),c(),F(" ",n.editMode()?"\u66F4\u65B0":"\u5275\u5EFA","\u4ED8\u6B3E\u8ACB\u6C42 "))},dependencies:[ot,nn,Ze,ct,lt,Xe,Ke,tn,Mn,xn,Sn,Tn,Dn,kn,Fn,mt,pt,bn,wn,X,Y,Q,q,Pn,En,O,B],encapsulation:2,changeDetection:0});var $t=Ct;var ki=(o,e)=>e.key,Mi=(o,e)=>e.name;function Ei(o,e){o&1&&(a(0,"div",23),m(1,"\u8F09\u5165\u4E2D..."),s())}function Pi(o,e){if(o&1){let t=S();a(0,"div",24)(1,"p"),m(2,"\u66AB\u7121\u4ED8\u6B3E\u8ACB\u6C42"),s(),a(3,"button",26),g("click",function(){d(t);let i=p(2).$implicit,r=p();return f(r.addPayment(i))}),m(4," \u65B0\u589E\u7B2C\u4E00\u500B\u4ED8\u6B3E\u8ACB\u6C42 "),s()()}}function Ni(o,e){if(o&1&&(a(0,"nz-tag",29),m(1),s()),o&2){let t=e.$implicit,n=p(5);l("nzColor",n.getStepStatusColor(t.status)),c(),F(" ",t.name," ")}}function Ii(o,e){if(o&1&&(a(0,"div",30),h(1,"span",37),m(2),s()),o&2){let t=p().$implicit;c(2),F(" ",t.attachments.length," \u500B\u9644\u4EF6 ")}}function Bi(o,e){if(o&1){let t=S();a(0,"button",38),g("click",function(){d(t);let i=p().$implicit,r=p(4);return f(r.submitPayment(i.key))}),m(1," \u63D0\u4EA4\u5BE9\u6279 "),s()}if(o&2){let t=p().$implicit,n=p(4);l("nzLoading",n.paymentSubmitting().has(t.key))}}function Oi(o,e){if(o&1){let t=S();a(0,"tr")(1,"td",39)(2,"app-contract-workflow-steps",40),g("workflowUpdated",function(){d(t);let i=p(4).$implicit,r=p();return f(r.onWorkflowUpdated(i.key))}),s()()()}if(o&2){let t=p().$implicit;c(2),l("payment",t)}}function Vi(o,e){if(o&1){let t=S();a(0,"tr")(1,"td"),m(2),Ee(3,"currency"),s(),a(4,"td")(5,"nz-tag",27),m(6),s()(),a(7,"td")(8,"div",28),Dt(9,Ni,2,2,"nz-tag",29,Mi),s()(),a(11,"td")(12,"div"),m(13),s(),N(14,Ii,3,1,"div",30),s(),a(15,"td")(16,"button",31),g("click",function(){let i=d(t).$implicit,r=p(4);return f(r.editPayment(i))}),m(17," \u7DE8\u8F2F "),s(),D(18,Bi,2,1,"button",32),a(19,"button",33),g("click",function(){let i=d(t).$implicit,r=p(4);return f(r.toggleWorkflowSteps(i.key))}),h(20,"span",34),m(21," \u6D41\u7A0B "),s(),a(22,"nz-popconfirm",35),g("nzOnConfirm",function(){let i=d(t).$implicit,r=p(4);return f(r.deletePayment(i.key))}),a(23,"button",36),m(24," \u522A\u9664 "),s()()()(),N(25,Oi,3,1,"tr")}if(o&2){let t=e.$implicit,n=p(4);c(2),K(Pe(3,10,t.amount,"TWD","symbol","1.0-0")),c(3),l("nzColor",n.getPaymentStatusColor(t.status)),c(),F(" ",n.getPaymentStatusText(t.status)," "),c(3),Tt(t.steps),c(4),K(n.formatPaymentDate(t.createdAt)),c(),I(t.attachments&&t.attachments.length>0?14:-1),c(2),l("disabled",t.status==="approved"||t.status==="rejected"),c(2),l("ngIf",t.status==="draft"),c(2),l("nzType",n.workflowStepsExpanded().has(t.key)?"up":"down"),c(3),l("disabled",t.status==="approved"),c(2),I(n.workflowStepsExpanded().has(t.key)?25:-1)}}function Li(o,e){if(o&1&&(a(0,"nz-table",25)(1,"thead")(2,"tr")(3,"th"),m(4,"\u4ED8\u6B3E\u91D1\u984D"),s(),a(5,"th"),m(6,"\u72C0\u614B"),s(),a(7,"th"),m(8,"\u5DE5\u4F5C\u6D41\u7A0B"),s(),a(9,"th"),m(10,"\u5275\u5EFA\u6642\u9593"),s(),a(11,"th"),m(12,"\u64CD\u4F5C"),s()()(),a(13,"tbody"),Dt(14,Vi,26,15,null,null,ki),s()()),o&2){let t=p(2).$implicit,n=p();l("nzData",n.getContractPayments(t.key))("nzShowPagination",!1),c(14),Tt(n.getContractPayments(t.key))}}function Ai(o,e){if(o&1){let t=S();a(0,"tr")(1,"td",18)(2,"div",19)(3,"div",20)(4,"h4"),m(5,"\u4ED8\u6B3E\u8ACB\u6C42\u5217\u8868"),s(),a(6,"button",21),g("click",function(){d(t);let i=p().$implicit,r=p();return f(r.addPayment(i))}),h(7,"span",22),m(8," \u65B0\u589E\u4ED8\u6B3E\u8ACB\u6C42 "),s()(),N(9,Ei,2,0,"div",23)(10,Pi,5,0,"div",24)(11,Li,16,2,"nz-table",25),s()()()}if(o&2){let t=p().$implicit,n=p();c(6),l("nzLoading",n.paymentLoading().has(t.key)),c(3),I(n.paymentLoading().has(t.key)?9:n.getContractPayments(t.key).length===0?10:11)}}function Ri(o,e){if(o&1){let t=S();a(0,"tr",9)(1,"td",10),g("nzExpandChange",function(i){let r=d(t).$implicit,u=p();return f(u.onExpandChange(r.key,i))}),s(),a(2,"td"),m(3),s(),a(4,"td")(5,"div",11),g("nzClick",function(){let i=d(t).$implicit,r=p();return f(r.currentDropdownRow=i)}),a(6,"a",12),g("click",function(){let i=d(t).$implicit,r=p();return f(r.currentDropdownRow=i)}),m(7),h(8,"span",13),s()()(),a(9,"td")(10,"div",14),g("click",function(){let i=d(t).$implicit,r=p();return f(r.startEdit(i.key))}),m(11),s(),a(12,"input",15),wt("ngModelChange",function(i){let r=d(t).$implicit;return vt(r.contractName,i)||(r.contractName=i),f(i)}),g("blur",function(){let i=d(t).$implicit,r=p();return f(r.stopEdit(i))}),s()(),a(13,"td")(14,"div",14),g("click",function(){let i=d(t).$implicit,r=p();return f(r.startEdit(i.key))}),m(15),s(),a(16,"input",15),wt("ngModelChange",function(i){let r=d(t).$implicit;return vt(r.contractCode,i)||(r.contractCode=i),f(i)}),g("blur",function(){let i=d(t).$implicit,r=p();return f(r.stopEdit(i))}),s()(),a(17,"td")(18,"div",14),g("click",function(){let i=d(t).$implicit,r=p();return f(r.startEdit(i.key))}),m(19),s(),a(20,"input",15),wt("ngModelChange",function(i){let r=d(t).$implicit;return vt(r.feeCode,i)||(r.feeCode=i),f(i)}),g("blur",function(){let i=d(t).$implicit,r=p();return f(r.stopEdit(i))}),s()(),a(21,"td")(22,"div",14),g("click",function(){let i=d(t).$implicit,r=p();return f(r.startEdit(i.key))}),m(23),s(),a(24,"input",16),wt("ngModelChange",function(i){let r=d(t).$implicit;return vt(r.amount,i)||(r.amount=i),f(i)}),g("blur",function(){let i=d(t).$implicit,r=p();return f(r.stopEdit(i))}),s()(),a(25,"td")(26,"a",17),g("nzOnConfirm",function(){let i=d(t).$implicit,r=p();return f(r.deleteRow(i.key))}),m(27,"\u522A\u9664"),s()()(),N(28,Ai,12,2,"tr")}if(o&2){let t=e.$implicit,n=p(),i=L(26);c(),l("nzExpand",n.expandSet().has(t.key)),c(2),K(t.contractSerial),c(2),l("nzDropdownMenu",i),c(2),F("",t.client," "),c(3),l("hidden",n.editId===t.key),c(),F(" ",t.contractName," "),c(),l("hidden",n.editId!==t.key),yt("ngModel",t.contractName),c(2),l("hidden",n.editId===t.key),c(),F(" ",t.contractCode," "),c(),l("hidden",n.editId!==t.key),yt("ngModel",t.contractCode),c(2),l("hidden",n.editId===t.key),c(),F(" ",t.feeCode," "),c(),l("hidden",n.editId!==t.key),yt("ngModel",t.feeCode),c(2),l("hidden",n.editId===t.key),c(),F(" ",t.amount," "),c(),l("hidden",n.editId!==t.key),yt("ngModel",t.amount),c(4),I(n.expandSet().has(t.key)?28:-1)}}function Wi(o,e){if(o&1){let t=S();a(0,"li",41),g("click",function(){let i=d(t).$implicit,r=p();return f(r.changeClient(r.currentDropdownRow,i))}),m(1),s()}if(o&2){let t=e.$implicit;c(),K(t)}}function $i(o,e){if(o&1){let t=S();a(0,"div")(1,"app-contract-payment-form",42),g("formSubmit",function(i){d(t);let r=p();return f(r.onPaymentFormSubmit(i))})("formCancel",function(){d(t);let i=p();return f(i.onPaymentModalCancel())}),s()()}if(o&2){let t,n=p();c(),l("payment",n.editingPayment())("contractId",((t=n.currentContract())==null?null:t.key)||"")}}var _t=class _t{constructor(e,t,n){this.contractService=e;this.paymentService=t;this.hubCrud=n;this.contracts=[];this.editId=null;this.clients=[];this.currentDropdownRow=null;this.expandSet=b(new Set);this.contractPayments=b(new Map);this.paymentLoading=b(new Set);this.paymentSubmitting=b(new Set);this.workflowStepsExpanded=b(new Set);this.showPaymentModal=b(!1);this.currentContract=b(null);this.editingPayment=b(null)}ngOnInit(){this.refresh(),this.contractService.getClientsSettings().then(e=>{this.clients=e?.list||[]})}refresh(){this.contractService.list().subscribe(e=>this.contracts=e)}addRow(){return _(this,null,function*(){let[e,t]=yield Promise.all([this.contractService.getDefaultClient(),this.contractService.getNextContractSerial()]),n={contractSerial:t,client:e,contractName:"",contractCode:"",feeCode:"",amount:0,payments:[]},i=yield this.contractService.add(n);this.contracts=[...this.contracts,P(M({},n),{key:i})],setTimeout(()=>{this.startEdit(i)},200)})}startEdit(e){e&&(this.editId=e,setTimeout(()=>{let t=document.querySelector("input[nz-input]:not([hidden])");t&&t.focus()},50))}stopEdit(e){return _(this,null,function*(){e.key&&(yield this.contractService.update(e.key,e)),this.editId=null})}deleteRow(e){return _(this,null,function*(){e&&(yield this.contractService.delete(e),this.contracts=this.contracts.filter(t=>t.key!==e))})}changeClient(e,t){return _(this,null,function*(){e&&e.key&&e.client!==t&&(e.client=t,yield this.contractService.update(e.key,{client:t}))})}onExpandChange(e,t){return _(this,null,function*(){let n=this.expandSet();t?(n.add(e),this.expandSet.set(new Set(n)),yield this.loadContractPayments(e)):(n.delete(e),this.expandSet.set(new Set(n)))})}loadContractPayments(e){return _(this,null,function*(){let t=this.paymentLoading();t.add(e),this.paymentLoading.set(new Set(t));try{let n=yield this.paymentService.listByContract(e),i=this.contractPayments();i.set(e,n),this.contractPayments.set(new Map(i))}catch(n){console.error("Failed to load payments:",n)}finally{let n=this.paymentLoading();n.delete(e),this.paymentLoading.set(new Set(n))}})}getContractPayments(e){return this.contractPayments().get(e)||[]}addPayment(e){if(!e.key){console.error("Contract key is missing");return}this.currentContract.set(e),this.editingPayment.set(null),this.showPaymentModal.set(!0)}editPayment(e){this.editingPayment.set(e),this.currentContract.set(this.contracts.find(t=>t.key===e.contractId)||null),this.showPaymentModal.set(!0)}onPaymentFormSubmit(e){return _(this,null,function*(){try{if(this.editingPayment())yield this.paymentService.update(this.editingPayment().key,{amount:e.amount,remark:e.remark,attachments:e.attachments}),console.log("\u4ED8\u6B3E\u8ACB\u6C42\u66F4\u65B0\u6210\u529F");else{let n=this.currentContract();if(!n?.key)throw new Error("\u5408\u7D04\u8CC7\u8A0A\u7F3A\u5931");yield this.paymentService.add(n.key,e.amount,e.remark,n.client),console.log("\u4ED8\u6B3E\u8ACB\u6C42\u5275\u5EFA\u6210\u529F")}this.onPaymentModalCancel();let t=this.currentContract()?.key;t&&(yield this.loadContractPayments(t))}catch(t){console.error("\u64CD\u4F5C\u5931\u6557\uFF1A",t)}})}onPaymentModalCancel(){this.showPaymentModal.set(!1),this.currentContract.set(null),this.editingPayment.set(null)}submitPayment(e){return _(this,null,function*(){let t=this.paymentSubmitting();t.add(e),this.paymentSubmitting.set(new Set(t));try{yield this.paymentService.submitPayment(e);let n=Array.from(this.expandSet());for(let i of n)yield this.loadContractPayments(i);console.log("Payment submitted successfully")}catch(n){console.error("Failed to submit payment:",n)}finally{let n=this.paymentSubmitting();n.delete(e),this.paymentSubmitting.set(new Set(n))}})}deletePayment(e){return _(this,null,function*(){try{yield this.paymentService.delete(e);let t=Array.from(this.expandSet());for(let n of t)yield this.loadContractPayments(n)}catch(t){console.error("Failed to delete payment:",t)}})}getPaymentStatusColor(e){return{draft:"default",submitted:"blue",reviewing:"orange",approved:"green",rejected:"red",invoiced:"purple",countdown:"cyan"}[e]||"default"}getPaymentStatusText(e){return{draft:"\u8349\u7A3F",submitted:"\u5DF2\u63D0\u4EA4",reviewing:"\u5BE9\u6838\u4E2D",approved:"\u5DF2\u6838\u51C6",rejected:"\u5DF2\u62D2\u7D55",invoiced:"\u5DF2\u958B\u7968",countdown:"\u5012\u6578\u4E2D"}[e]||e}getStepStatusColor(e){return{pending:"orange",done:"green",rejected:"red",waiting:"default"}[e]||"default"}formatPaymentDate(e){if(!e)return"";try{return e.toDate?e.toDate().toLocaleDateString("zh-TW"):e instanceof Date?e.toLocaleDateString("zh-TW"):typeof e=="number"?new Date(e).toLocaleDateString("zh-TW"):""}catch(t){return console.error("Date formatting error:",t),""}}toggleWorkflowSteps(e){let t=this.workflowStepsExpanded();t.has(e)?t.delete(e):t.add(e),this.workflowStepsExpanded.set(new Set(t))}onWorkflowUpdated(e){return _(this,null,function*(){yield this.loadContractPayments(e)})}};_t.\u0275fac=function(t){return new(t||_t)(J(Vn),J(ft),J(ut))},_t.\u0275cmp=T({type:_t,selectors:[["contract-list"]],decls:31,vars:6,consts:[["editRowTable",""],["menuRef","nzDropdownMenu"],[3,"onAction"],["nzBordered","",3,"nzData"],["nzWidth","50px"],["nz-menu",""],["nz-menu-item","",3,"click",4,"ngFor","ngForOf"],[3,"nzOnCancel","nzVisible","nzTitle","nzFooter","nzWidth"],[4,"nzModalContent"],[1,"editable-row"],[3,"nzExpandChange","nzExpand"],["nz-dropdown","","nzTrigger","click",3,"nzClick","nzDropdownMenu"],["nz-dropdown","",3,"click"],["nz-icon","","nzType","down"],[1,"editable-cell",3,"click","hidden"],["type","text","nz-input","",3,"ngModelChange","blur","hidden","ngModel"],["type","number","nz-input","",3,"ngModelChange","blur","hidden","ngModel"],["nz-popconfirm","","nzPopconfirmTitle","\u78BA\u5B9A\u522A\u9664\uFF1F",3,"nzOnConfirm"],["colspan","8",1,"payment-expand-row"],[1,"payment-sub-table"],[1,"payment-header"],["nz-button","","nzType","primary","nzSize","small",3,"click","nzLoading"],["nz-icon","","nzType","plus"],[1,"payment-loading"],[1,"payment-empty"],["nzSize","small",3,"nzData","nzShowPagination"],["nz-button","","nzType","dashed",3,"click"],[3,"nzColor"],[1,"workflow-steps"],["nzSize","small",2,"margin-right","4px","margin-bottom","2px",3,"nzColor"],[1,"attachment-info"],["nz-button","","nzType","link","nzSize","small",3,"click","disabled"],["nz-button","","nzType","primary","nzSize","small","style","margin-left: 4px;",3,"nzLoading","click",4,"ngIf"],["nz-button","","nzType","link","nzSize","small",2,"margin-left","4px",3,"click"],["nz-icon","",3,"nzType"],["nzTitle","\u78BA\u5B9A\u8981\u522A\u9664\u6B64\u4ED8\u6B3E\u8ACB\u6C42\u55CE\uFF1F",3,"nzOnConfirm"],["nz-button","","nzType","link","nzSize","small","nzDanger","","nz-popconfirm","",3,"disabled"],["nz-icon","","nzType","paper-clip"],["nz-button","","nzType","primary","nzSize","small",2,"margin-left","4px",3,"click","nzLoading"],["colspan","5",1,"workflow-steps-row"],[3,"workflowUpdated","payment"],["nz-menu-item","",3,"click"],[3,"formSubmit","formCancel","payment","contractId"]],template:function(t,n){if(t&1){let i=S();a(0,"app-fab",2),g("onAction",function(){return d(i),f(n.addRow())}),s(),h(1,"br")(2,"br"),a(3,"nz-table",3,0)(5,"thead")(6,"tr"),h(7,"th",4),a(8,"th"),m(9,"\u5E8F\u865F"),s(),a(10,"th"),m(11,"\u696D\u4E3B"),s(),a(12,"th"),m(13,"\u5408\u7D04\u540D\u7A31"),s(),a(14,"th"),m(15,"\u5408\u7D04\u6848\u865F\u8B58\u5225\u78BC"),s(),a(16,"th"),m(17,"\u5408\u7D04\u8CBB\u7528\u8B58\u5225\u78BC"),s(),a(18,"th"),m(19,"\u5408\u7D04\u91D1\u984D"),s(),a(20,"th"),m(21,"\u64CD\u4F5C"),s()()(),a(22,"tbody"),Dt(23,Ri,29,21,null,null,we),s()(),a(25,"nz-dropdown-menu",null,1)(27,"ul",5),D(28,Wi,2,1,"li",6),s()(),a(29,"nz-modal",7),g("nzOnCancel",function(){return d(i),f(n.onPaymentModalCancel())}),D(30,$i,2,2,"div",8),s()}if(t&2){let i=L(4);c(3),l("nzData",n.contracts),c(20),Tt(i.data),c(5),l("ngForOf",n.clients),c(),l("nzVisible",n.showPaymentModal())("nzTitle",n.editingPayment()?"\u7DE8\u8F2F\u4ED8\u6B3E\u8ACB\u6C42":"\u65B0\u589E\u4ED8\u6B3E\u8ACB\u6C42")("nzFooter",null)("nzWidth",600)}},dependencies:[ot,Ft,kt,Bt,ct,Je,lt,It,vn,hn,fn,Cn,gn,yn,_n,zn,X,Y,Q,q,mt,pt,Ot,dn,un,mn,sn,an,cn,ln,pn,Nt,Pt,He,rn,on,O,B,Lt,Rt,$t,Oe],styles:[".editable-cell[_ngcontent-%COMP%]{position:relative;padding:5px 12px;cursor:pointer}.editable-row[_ngcontent-%COMP%]:hover   .editable-cell[_ngcontent-%COMP%]{border:1px solid #d9d9d9;border-radius:4px;padding:4px 11px}.payment-expand-row[_ngcontent-%COMP%]{padding:0!important}.payment-sub-table[_ngcontent-%COMP%]{padding:16px}.payment-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}.payment-header[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%]{margin:0;font-size:14px}.payment-loading[_ngcontent-%COMP%], .payment-empty[_ngcontent-%COMP%]{text-align:center;padding:24px}.payment-empty[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin-bottom:12px}.workflow-steps[_ngcontent-%COMP%]{max-width:200px}.attachment-info[_ngcontent-%COMP%]{margin-top:4px;font-size:12px}.attachment-info[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{margin-right:4px}.workflow-steps-row[_ngcontent-%COMP%]{padding:0!important}"],changeDetection:0});var Ut=_t;var ht=class ht{};ht.\u0275fac=function(t){return new(t||ht)},ht.\u0275cmp=T({type:ht,selectors:[["hub-contract"]],decls:1,vars:0,template:function(t,n){t&1&&h(0,"contract-list")},dependencies:[Ut],encapsulation:2});var $n=ht;export{$n as HubContractComponent};
