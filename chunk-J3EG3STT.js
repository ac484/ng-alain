import{b as S,d as x,e as N,f as p,g as l,h as g,i as o,j as O,k as I,m as D,n as T,o as j,p as y,q as v}from"./chunk-CVWZRLFH.js";import{oa as m,sa as h,ta as P}from"./chunk-MUKALFIJ.js";import{a as k,i}from"./chunk-57BLH6QZ.js";var u=class u{constructor(){this.firestore=P(S)}get firestoreInstance(){return this.firestore}useCollection(e){let t=l(this.firestore,e);return x(t,{idField:"key"})}useDoc(e,t){let r=o(this.firestore,e,t);return N(r,{idField:"key"})}add(e,t){return i(this,null,function*(){let r=l(this.firestore,e);return(yield p(r,t)).id})}update(e,t,r){return i(this,null,function*(){let s=o(this.firestore,e,t);yield y(s,r)})}delete(e,t){return i(this,null,function*(){let r=o(this.firestore,e,t);yield g(r)})}};u.\u0275fac=function(t){return new(t||u)},u.\u0275prov=m({token:u,factory:u.\u0275fac,providedIn:"root"});var b=u;var d=class d{constructor(e){this.hubCrud=e;this.collectionName="hub_workflow_definitions"}listTemplates(){return this.hubCrud.useCollection(this.collectionName)}getTemplateForClient(e){return i(this,null,function*(){let t=l(this.hubCrud.firestoreInstance,this.collectionName),r=D(t,v("clientId","==",e),v("isActive","==",!0)),s=yield I(r);if(s.empty)return null;let n=s.docs[0];return k({key:n.id},n.data())})}createTemplate(e){return i(this,null,function*(){let t=l(this.hubCrud.firestoreInstance,this.collectionName);return(yield p(t,e)).id})}updateTemplate(e,t){return i(this,null,function*(){let r=o(this.hubCrud.firestoreInstance,this.collectionName,e);yield y(r,t)})}deleteTemplate(e){return i(this,null,function*(){if(yield this.isTemplateInUse(e))throw new Error("Cannot delete workflow template: it is currently in use by active payments");let r=o(this.hubCrud.firestoreInstance,this.collectionName,e);yield g(r)})}isTemplateInUse(e){return i(this,null,function*(){let t=l(this.hubCrud.firestoreInstance,"hub_contract_payments"),r=D(t,v("workflowId","==",e));return!(yield I(r)).empty})}};d.\u0275fac=function(t){return new(t||d)(h(b))},d.\u0275prov=m({token:d,factory:d.\u0275fac,providedIn:"root"});var A=d;var f=class f{constructor(e){this.hubCrud=e}list(){return this.hubCrud.useCollection("hub_contract")}add(e){return this.hubCrud.add("hub_contract",e)}update(e,t){return this.hubCrud.update("hub_contract",e,t)}delete(e){return this.hubCrud.delete("hub_contract",e)}getNextContractSerial(){return i(this,null,function*(){let e=o(this.hubCrud.firestoreInstance,"hub/meta/counters/contractSerial"),t=1;return yield T(this.hubCrud.firestoreInstance,r=>i(this,null,function*(){let s=yield r.get(e),n=0,a=[];if(!s.exists())n=1,a=[],r.set(e,{value:n,available:a}),t=n;else{let c=s.data();n=c.value||0,a=Array.isArray(c.available)?[...c.available]:[],a.length>0?(a.sort((C,w)=>C-w),t=a.shift(),r.update(e,{available:a})):(t=n+1,r.update(e,{value:t}))}})),"C"+String(t).padStart(5,"0")})}recycleContractSerial(e){return i(this,null,function*(){let t=Number(e.replace(/^C/,""));if(!t||isNaN(t))return;let r=o(this.hubCrud.firestoreInstance,"hub/meta/counters/contractSerial");yield T(this.hubCrud.firestoreInstance,s=>i(this,null,function*(){let n=yield s.get(r);if(!n.exists())s.set(r,{value:t,available:[t]});else{let a=n.data(),c=Array.isArray(a.available)?[...a.available]:[];c.includes(t)||(c.push(t),c.sort((C,w)=>C-w),s.update(r,{available:c}))}}))})}getClientsSettings(){return i(this,null,function*(){let e=o(this.hubCrud.firestoreInstance,"hub/meta/settings/clients"),t=yield O(e);return t.exists()?t.data():null})}setClientsSettings(e){return i(this,null,function*(){let t=o(this.hubCrud.firestoreInstance,"hub/meta/settings/clients");yield j(t,e)})}getDefaultClient(){return i(this,null,function*(){return(yield this.getClientsSettings())?.default||""})}};f.\u0275fac=function(t){return new(t||f)(h(b))},f.\u0275prov=m({token:f,factory:f.\u0275fac,providedIn:"root"});var W=f;export{b as a,A as b,W as c};
