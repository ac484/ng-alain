import{a as ze,b as ye}from"./chunk-IT2WW2S3.js";import{a as Pe,b as Ce}from"./chunk-33JE6QLI.js";import"./chunk-B57ZRTQQ.js";import{a as de,c as ue,d as pe,e as fe}from"./chunk-URYHEPIR.js";import"./chunk-4DTPEWDV.js";import{k as ce}from"./chunk-EPZ2YTFW.js";import"./chunk-FPS6RETX.js";import"./chunk-7ZDABVNP.js";import{z as re}from"./chunk-QYQDWNIT.js";import{i as X,j as ee,k as te}from"./chunk-S65JMQD3.js";import{a as se,b as ae}from"./chunk-IIXLJNZR.js";import{a as le,b as me}from"./chunk-6PTBEDPF.js";import{d as ne}from"./chunk-NJX4IC2M.js";import"./chunk-F72TEBSM.js";import"./chunk-GR6IQZZQ.js";import{a as ie,c as oe}from"./chunk-D3MYSTZR.js";import"./chunk-JW2DH5H2.js";import{f as he,g as ge}from"./chunk-NIB5VKWS.js";import{a as Y,b as q,d as H,e as Q}from"./chunk-UE3L6XDQ.js";import"./chunk-DHL22JEN.js";import"./chunk-UHJZXVT3.js";import"./chunk-TSPYDFJT.js";import"./chunk-QXNAVHW5.js";import"./chunk-ID3V7ETC.js";import"./chunk-CRON3LQ5.js";import"./chunk-HMC5XIIT.js";import{Gd as W,Kb as P,Kh as G,Lb as d,Lh as Z,Mb as m,Nb as T,Ub as M,Xb as x,_a as f,_b as C,db as N,ja as S,kb as R,nc as h,oc as L,qb as b,sc as B,tc as $,ua as w,uc as J,va as v,xd as K}from"./chunk-67N3UCKF.js";import"./chunk-PMZOYKO3.js";import{i as D}from"./chunk-57BLH6QZ.js";var k={workerSrc:"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js",cMapUrl:"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/cmaps/",cMapPacked:!0,standardFontDataUrl:"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/standard_fonts/"};function Fe(){return new Promise((c,e)=>{if(typeof window>"u"){e(new Error("PDF.js \u53EA\u80FD\u5728\u700F\u89BD\u5668\u74B0\u5883\u4E2D\u4F7F\u7528"));return}if(window.pdfjsLib){c();return}let t=document.createElement("script");t.src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js",t.onload=()=>{let n=window.pdfjsLib;n.GlobalWorkerOptions.workerSrc=k.workerSrc,n.cMapUrl=k.cMapUrl,n.cMapPacked=k.cMapPacked,n.standardFontDataUrl=k.standardFontDataUrl,n.GlobalWorkerOptions.verbosity=0,c()},t.onerror=()=>e(new Error("PDF.js \u8F09\u5165\u5931\u6557")),document.head.appendChild(t)})}function _e(){return typeof window<"u"&&!!window.pdfjsLib}function Oe(){if(!_e())throw new Error("PDF.js \u672A\u521D\u59CB\u5316\uFF0C\u8ACB\u5148\u8ABF\u7528 initializePDFJS()");return window.pdfjsLib}var z=class z{constructor(){this.isInitialized=!1;this.initPDFJS()}initPDFJS(){return D(this,null,function*(){if(!this.isInitialized)try{yield Fe(),this.isInitialized=!0}catch(e){throw console.error("PDF.js \u521D\u59CB\u5316\u5931\u6557:",e),new Error("PDF \u89E3\u6790\u5EAB\u521D\u59CB\u5316\u5931\u6557")}})}parsePDF(e){return D(this,null,function*(){try{this.isInitialized||(yield this.initPDFJS());let t=yield e.arrayBuffer(),i=yield Oe().getDocument({data:t,verbosity:0}).promise,o=i.numPages,s=[];for(let u=1;u<=o;u++)try{let F=(yield(yield i.getPage(u)).getTextContent({normalizeWhitespace:!0})).items.map(p=>({text:p.str,x:p.transform[4],y:p.transform[5]}));F.sort((p,U)=>{let A=U.y-p.y;return Math.abs(A)>5?A:p.x-U.x});let O=[],a="",_=F[0]?.y||0;F.forEach(p=>{Math.abs(p.y-_)>5?(a.trim()&&O.push(a.trim()),a=p.text,_=p.y):a+=" "+p.text}),a.trim()&&O.push(a.trim()),s.push(...O.filter(p=>p.trim()))}catch(g){console.warn(`\u7B2C ${u} \u9801\u89E3\u6790\u5931\u6557:`,g)}let l=this.extractCustomerPOStructure(s);return{success:!0,data:s,customerPOItems:l,pageCount:o}}catch(t){return{success:!1,error:t instanceof Error?t.message:"PDF \u89E3\u6790\u5931\u6557",pageCount:0}}})}isValidPDF(e){return e.type==="application/pdf"||e.name.toLowerCase().endsWith(".pdf")}formatFileSize(e){if(e===0)return"0 Bytes";let t=1024,n=["Bytes","KB","MB","GB"],r=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,r)).toFixed(2))+" "+n[r]}extractCustomerPOStructure(e){let t=[],n=/([A-Z0-9]+)\(Cost Ref:\s*([^)]+)\)\(Customer PO:\s*\)(.+)/;for(let r=0;r<e.length;r++){let i=e[r].trim();if(i.includes("Customer PO:")){let o="",s="",l="",u=i,g=i.match(n);if(g)o=g[1],s=g[2],l=g[3].trim();else{let V=i.match(/\(Cost Ref:\s*([^)]+)\)/);V&&(s=V[1].trim());let F=i.match(/^([A-Z0-9]+)(?:\(|\s)/);F&&(o=F[1].trim());let O=i.indexOf("Customer PO:");if(O!==-1){let a=i.substring(O+12).trim();if(a&&!a.startsWith(")"))l=a.replace(/\(Cost Ref:\s*[^)]+\)/,"").trim();else if(a.startsWith(")")){let _=a.substring(1).trim();_&&(l=_)}}if(!l&&r+1<e.length){let a=e[r+1].trim();!a.includes("Customer PO:")&&!a.includes("Cost Ref:")&&a.length>0&&(l=a,r++)}}t.push({customerPO:o?`${o}(Customer PO:)`:u,content:l,costRef:s||void 0})}}return t}getFileInfo(e){return{name:e.name,size:this.formatFileSize(e.size),type:e.type}}};z.\u0275fac=function(t){return new(t||z)},z.\u0275prov=S({token:z,factory:z.\u0275fac,providedIn:"root"});var E=z;var y=class y{convertCustomerPOToTree(e){let t=[],n=0;return e.forEach((r,i)=>{let o=[],s="",l=r.customerPO.match(/^([A-Z0-9]+)\(/);l&&(s=l[1]),r.content&&o.push({title:r.content,key:`content-${n++}`,isLeaf:!0,data:{type:"content",value:r.content}}),r.costRef&&o.push({title:`Cost Ref: ${r.costRef}`,key:`costref-${n++}`,isLeaf:!0,data:{type:"costRef",value:r.costRef}});let u="";s?u=`${i+1}. ${s} (Customer PO)`:u=`${i+1}. ${r.customerPO.includes("Customer PO:")?r.customerPO:`Customer PO: ${r.customerPO}`}`;let g={title:u,key:`customerpo-${n++}`,children:o,isLeaf:o.length===0,data:{type:"customerPO",customerPO:r.customerPO,content:r.content,costRef:r.costRef,identifier:s||void 0}};t.push(g)}),t}convertToTree(e,t=100){let n=[],r=0;return e.filter(o=>o.trim()).slice(0,t).forEach(o=>{let s=o.trim();if(!s)return;let l={title:this.truncateTitle(s),key:`node-${r++}`,isLeaf:!0};n.push(l)}),n}truncateTitle(e,t=50){return e.length>t?e.substring(0,t)+"...":e}getAllKeys(e){let t=[];return e.forEach(n=>{t.push(n.key),n.children&&t.push(...this.getAllKeys(n.children))}),t}countNodes(e){let t=0;return e.forEach(n=>{t++,n.children&&(t+=this.countNodes(n.children))}),t}};y.\u0275fac=function(t){return new(t||y)},y.\u0275prov=S({token:y,factory:y.\u0275fac,providedIn:"root"});var j=y;function ve(c,e){if(c&1){let t=M();d(0,"div",11),T(1,"nz-alert",12),d(2,"div",11)(3,"button",13),x("click",function(){w(t);let r=C();return v(r.exportToJson())}),T(4,"span",14),h(5," \u532F\u51FA JSON "),m()()()}if(c&2){let t=C();f(),P("nzMessage","\u6210\u529F\u63D0\u53D6 "+t.customerPOItems.length+" \u500B Customer PO \u9805\u76EE")}}function be(c,e){c&1&&(d(0,"div",15)(1,"nz-empty",16)(2,"span"),h(3,"\u5C1A\u672A\u532F\u5165 PDF \u6A94\u6848"),m()()())}function Te(c,e){if(c&1){let t=M();d(0,"nz-tree",17),x("nzExpandChange",function(r){w(t);let i=C();return v(i.onExpandChange(r))})("nzClick",function(r){w(t);let i=C();return v(i.onNodeClick(r))}),m()}if(c&2){let t=C();P("nzData",t.treeData)("nzBlockNode",!0)("nzShowLine",!0)("nzShowIcon",!0)("nzExpandedKeys",t.expandedKeys)}}function Se(c,e){if(c&1&&(d(0,"nz-form-item")(1,"nz-form-label"),h(2,"\u6A94\u6848\u4FE1\u606F"),m(),d(3,"nz-form-control")(4,"div",21)(5,"p")(6,"strong"),h(7,"\u6A94\u540D\uFF1A"),m(),h(8),m(),d(9,"p")(10,"strong"),h(11,"\u5927\u5C0F\uFF1A"),m(),h(12),m()()()()),c&2){let t=C(2);f(8),L(t.getFileInfo(t.selectedFile).name),f(4),L(t.getFileInfo(t.selectedFile).size)}}function Ne(c,e){if(c&1){let t=M();d(0,"div"),T(1,"nz-alert",18),d(2,"nz-form-item")(3,"nz-form-label"),h(4,"\u9078\u64C7\u6A94\u6848"),m(),d(5,"nz-form-control")(6,"input",19),x("change",function(r){w(t);let i=C();return v(i.onFileSelected(r))}),m()()(),b(7,Se,13,2,"nz-form-item",20),m()}if(c&2){let t=C();f(7),P("ngIf",t.selectedFile)}}var I=class I{constructor(e,t,n){this.message=e;this.pdfService=t;this.treeConverter=n;this.treeData=[];this.expandedKeys=[];this.isUploadModalVisible=!1;this.isProcessing=!1;this.selectedFile=null;this.customerPOItems=[];this.showCustomerPOView=!1}showUploadModal(){this.isUploadModalVisible=!0,this.selectedFile=null}cancelUpload(){this.isUploadModalVisible=!1,this.selectedFile=null}onFileSelected(e){let t=e.target.files[0];t&&this.pdfService.isValidPDF(t)?this.selectedFile=t:this.message.error("\u8ACB\u9078\u64C7\u6709\u6548\u7684 PDF \u6A94\u6848")}getFileInfo(e){return this.pdfService.getFileInfo(e)}confirmUpload(){return D(this,null,function*(){if(!this.selectedFile){this.message.warning("\u8ACB\u9078\u64C7 PDF \u6A94\u6848");return}this.isProcessing=!0,this.message.info("\u958B\u59CB\u89E3\u6790 PDF \u6A94\u6848...");try{let e=yield this.pdfService.parsePDF(this.selectedFile);if(e.success&&e.data){if(e.customerPOItems&&e.customerPOItems.length>0){this.customerPOItems=e.customerPOItems,this.treeData=this.treeConverter.convertCustomerPOToTree(e.customerPOItems),this.showCustomerPOView=!0;let t=e.customerPOItems.filter(n=>n.content).length;this.message.success(`PDF \u89E3\u6790\u6210\u529F\uFF0C\u5171 ${e.pageCount} \u9801\uFF0C\u627E\u5230 ${e.customerPOItems.length} \u500B Customer PO \u9805\u76EE\uFF0C\u5176\u4E2D ${t} \u500B\u6709\u5167\u5BB9`),t<e.customerPOItems.length&&this.message.warning(`\u6709 ${e.customerPOItems.length-t} \u500B Customer PO \u9805\u76EE\u6C92\u6709\u63D0\u53D6\u5230\u5167\u5BB9`)}else this.treeData=this.treeConverter.convertToTree(e.data),this.showCustomerPOView=!1,this.message.success(`PDF \u89E3\u6790\u6210\u529F\uFF0C\u5171 ${e.pageCount} \u9801\uFF0C\u751F\u6210 ${this.treeData.length} \u500B\u7BC0\u9EDE`);this.expandedKeys=this.treeConverter.getAllKeys(this.treeData),this.isUploadModalVisible=!1}else this.message.error("PDF \u89E3\u6790\u5931\u6557\uFF1A"+(e.error||"\u672A\u77E5\u932F\u8AA4"))}catch(e){this.message.error("\u8655\u7406\u904E\u7A0B\u4E2D\u767C\u751F\u932F\u8AA4\uFF1A"+e)}finally{this.isProcessing=!1}})}onExpandChange(e){this.expandedKeys=e.keys}onNodeClick(e){console.log("\u7BC0\u9EDE\u9EDE\u64CA:",e),e.node&&e.node.origin&&e.node.origin.data&&console.log("\u7BC0\u9EDE\u6578\u64DA:",e.node.origin.data)}resetData(){this.treeData=[],this.expandedKeys=[],this.customerPOItems=[],this.showCustomerPOView=!1}exportToJson(){if(!this.customerPOItems||this.customerPOItems.length===0){this.message.warning("\u6C92\u6709\u53EF\u532F\u51FA\u7684Customer PO\u9805\u76EE");return}try{let e=this.customerPOItems.map((o,s)=>{let l="",u=o.customerPO.match(/^([A-Z0-9]+)\(/);return u&&(l=u[1]),{id:s+1,identifier:l||void 0,customerPO:o.customerPO,content:o.content||"",costRef:o.costRef||void 0}}),t=JSON.stringify(e,null,2),n=new Blob([t],{type:"application/json"}),r=URL.createObjectURL(n),i=document.createElement("a");i.href=r,i.download=`customer_po_items_${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(r),this.message.success("\u6210\u529F\u532F\u51FACustomer PO\u9805\u76EE")}catch(e){this.message.error("\u532F\u51FA\u5931\u6557: "+e)}}};I.\u0275fac=function(t){return new(t||I)(N(ne),N(E),N(j))},I.\u0275cmp=R({type:I,selectors:[["app-tree-pdf-import"]],decls:12,vars:6,consts:[["title","PDF \u532F\u5165\u529F\u80FD"],[2,"margin-bottom","16px"],["nz-button","","nzType","primary",3,"click"],["nz-icon","","nzType","upload"],["style","margin-top: 8px;",4,"ngIf"],[3,"nzSpinning"],[1,"tree-container"],["class","empty-state",4,"ngIf"],[3,"nzData","nzBlockNode","nzShowLine","nzShowIcon","nzExpandedKeys","nzExpandChange","nzClick",4,"ngIf"],["nzTitle","PDF \u6A94\u6848\u532F\u5165",3,"nzVisibleChange","nzOnCancel","nzOnOk","nzVisible","nzOkDisabled"],[4,"nzModalContent"],[2,"margin-top","8px"],["nzType","success","nzShowIcon","",3,"nzMessage"],["nz-button","","nzType","default",3,"click"],["nz-icon","","nzType","download"],[1,"empty-state"],["nzNotFoundImage","simple"],[3,"nzExpandChange","nzClick","nzData","nzBlockNode","nzShowLine","nzShowIcon","nzExpandedKeys"],["nzType","info","nzMessage","\u652F\u63F4\u4E2D\u82F1\u6587 PDF \u6A94\u6848\uFF0C\u81EA\u52D5\u63D0\u53D6\u6587\u5B57\u4E26\u8F49\u63DB\u70BA\u6A39\u72C0\u7D50\u69CB",2,"margin-bottom","16px"],["type","file","accept",".pdf",2,"width","100%",3,"change"],[4,"ngIf"],[2,"padding","8px","background-color","#f5f5f5","border-radius","4px"]],template:function(t,n){t&1&&(d(0,"nz-card",0)(1,"div",1)(2,"button",2),x("click",function(){return n.showUploadModal()}),T(3,"span",3),h(4," \u9078\u64C7 PDF \u6A94\u6848 "),m(),b(5,ve,6,1,"div",4),m(),d(6,"nz-spin",5)(7,"div",6),b(8,be,4,0,"div",7)(9,Te,1,5,"nz-tree",8),m()(),d(10,"nz-modal",9),J("nzVisibleChange",function(i){return $(n.isUploadModalVisible,i)||(n.isUploadModalVisible=i),i}),x("nzOnCancel",function(){return n.cancelUpload()})("nzOnOk",function(){return n.confirmUpload()}),b(11,Ne,8,1,"div",10),m()()),t&2&&(f(5),P("ngIf",n.showCustomerPOView&&n.customerPOItems.length>0),f(),P("nzSpinning",n.isProcessing),f(2),P("ngIf",n.treeData.length===0),f(),P("ngIf",n.treeData.length>0),f(),B("nzVisible",n.isUploadModalVisible),P("nzOkDisabled",!n.selectedFile))},dependencies:[W,K,ge,he,ye,ze,Q,H,Y,q,Z,G,te,ee,X,ce,fe,me,le,de,pe,ue,Ce,Pe,ae,se,oe,ie,re],styles:[".tree-container[_ngcontent-%COMP%]{border:1px solid #d9d9d9;border-radius:6px;min-height:300px;padding:16px}.empty-state[_ngcontent-%COMP%]{display:flex;justify-content:center;align-items:center;height:200px}"]});var Ie=I;export{Ie as TreePdfImportComponent};
