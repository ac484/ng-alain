import{a as ee,b as te,e as ie}from"./chunk-22JOMLV4.js";import{b as V,d as j,g as k,h as B,i as m,j as G,n as P,o as R}from"./chunk-22S67FWE.js";import{b as A}from"./chunk-UUGZREJK.js";import{d as Q}from"./chunk-W2F5J6VW.js";import{d as q,e as H,g as J,h as L,n as U,q as W,t as X,x as Y,z as Z}from"./chunk-B7TLEUBG.js";import{Aa as h,B as M,Ba as v,Cc as I,Dc as $,Ec as K,Fb as D,Lb as x,Nc as c,Ob as T,fc as N,gc as o,hc as n,ic as g,kd as O,oa as _,pc as E,sa as z,sb as w,u as F,vc as b,yb as l,yc as S}from"./chunk-ONJQPJYD.js";import{a as p,b as f,h as C}from"./chunk-HN2SGUN4.js";var a=class a{constructor(t){this.firestore=t;this.collectionName="tree-nodes"}getNodes(){let t=k(this.firestore,this.collectionName);return j(t,{idField:"id"})}getNode(t){let e=m(this.firestore,`${this.collectionName}/${t}`);return F(G(e)).pipe(M(i=>{if(!i.exists())return;let r=i.data();return f(p({},r),{id:i.id})}))}addNode(t){let e=m(this.firestore,`${this.collectionName}/${t.id}`);return P(e,t)}updateNode(t,e){let i=m(this.firestore,`${this.collectionName}/${t}`);return R(i,f(p({},e),{updatedAt:new Date().toISOString()}))}deleteNode(t){let e=m(this.firestore,`${this.collectionName}/${t}`);return B(e)}moveNodesBatch(t){let e=te();return ie(e,i=>C(this,null,function*(){for(let r of t){let s=ee(e,`${this.collectionName}/${r.id}`);i.update(s,{parentKey:r.parentKey,order:r.order,updatedAt:new Date().toISOString()})}}))}};a.\u0275fac=function(e){return new(e||a)(z(V))},a.\u0275prov=_({token:a,factory:a.\u0275fac,providedIn:"root"});var u=a;var ae=["crudModal"];function de(y,t){if(y&1){let e=E();o(0,"form",1),b("ngSubmit",function(){let r=h(e).$implicit,s=S();return v(s.handleOk(r))}),o(1,"div",2)(2,"div",3)(3,"label"),c(4,"\u6A19\u984C"),n()(),o(5,"div",4),g(6,"input",5),n()(),o(7,"div",2)(8,"div",3)(9,"label"),c(10,"\u7236\u7BC0\u9EDE"),n()(),o(11,"div",4),g(12,"input",6),n()(),o(13,"div",7)(14,"button",8),b("click",function(){let r=h(e).$implicit;return v(r.destroy())}),c(15,"\u53D6\u6D88"),n(),o(16,"button",9),c(17,"\u78BA\u5B9A"),n()()()}if(y&2){let e=S();N("formGroup",e.nodeForm),w(16),N("disabled",!e.nodeForm.valid)}}var d=class d{constructor(t,e,i,r){this.fb=t;this.modal=e;this.message=i;this.crud=r;this.dataChanged=new T;this.isEditMode=!1;this.modalTitle="\u65B0\u589E\u7BC0\u9EDE";this.editNodeId=null;this.nodeForm=this.fb.group({title:["",H.required],parentKey:[""]})}refresh(){}showAddModal(t){this.isEditMode=!1,this.modalTitle="\u65B0\u589E\u7BC0\u9EDE",this.nodeForm.reset({title:"",parentKey:t??""}),this.modal.create({nzTitle:this.modalTitle,nzContent:this.crudModal,nzFooter:null})}showEditModal(t){this.isEditMode=!0,this.modalTitle="\u7DE8\u8F2F\u7BC0\u9EDE",this.editNodeId=t.id,this.nodeForm.reset({title:t.title,parentKey:t.parentKey??""}),this.modal.create({nzTitle:this.modalTitle,nzContent:this.crudModal,nzFooter:null})}handleOk(t){if(this.nodeForm.valid){let e=this.nodeForm.value;if(this.isEditMode&&this.editNodeId)this.crud.updateNode(this.editNodeId,{title:e.title,parentKey:e.parentKey||null}).then(()=>{this.message.success("\u7BC0\u9EDE\u66F4\u65B0\u6210\u529F"),t.destroy(),this.refresh(),this.dataChanged.emit()});else{let i=new Date().toISOString(),r=`node-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,s={id:r,key:r,title:e.title,name:e.title,type:"branch",status:"active",order:0,parentKey:e.parentKey||null,createdAt:i,updatedAt:i};this.crud.addNode(s).then(()=>{this.message.success("\u7BC0\u9EDE\u65B0\u589E\u6210\u529F"),t.destroy(),this.refresh(),this.dataChanged.emit()})}}}deleteNode(t){this.crud.deleteNode(t.id).then(()=>{this.message.success("\u522A\u9664\u6210\u529F"),this.refresh(),this.dataChanged.emit()})}};d.\u0275fac=function(e){return new(e||d)(l(Y),l(A),l(Q),l(u))},d.\u0275cmp=D({type:d,selectors:[["app-firebase-crud"]],viewQuery:function(e,i){if(e&1&&I(ae,7),e&2){let r;$(r=K())&&(i.crudModal=r.first)}},outputs:{dataChanged:"dataChanged"},decls:2,vars:0,consts:[["crudModal",""],[3,"ngSubmit","formGroup"],["nz-form-item",""],["nz-form-label",""],["nz-form-control",""],["nz-input","","formControlName","title"],["nz-input","","formControlName","parentKey"],[2,"text-align","right"],["nz-button","","nzType","default",3,"click"],["nz-button","","nzType","primary","htmlType","submit",3,"disabled"]],template:function(e,i){e&1&&x(0,de,18,2,"ng-template",null,0,O)},dependencies:[Z,U,q,J,L,W,X],encapsulation:2});var re=d;export{u as a,re as b};
