<div class="settings-page">
  <nz-tabset nzType="card">
    <!-- 業主清單管理 -->
    <nz-tab nzTitle="業主管理">
      <nz-card nzTitle="業主清單管理" [nzLoading]="isLoading()">
        <div style="margin-bottom: 16px;">
          <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 16px;">
            <input nz-input placeholder="新增業主" [value]="clientInput()" (input)="updateClientInput($event.target.value)"
              (keyup.enter)="addClient()" style="width: 200px;" />
            <button nz-button nzType="primary" (click)="addClient()" [disabled]="!clientInput().trim()">
              <span nz-icon nzType="plus"></span>
              新增業主
            </button>
          </div>

          <div style="margin-bottom: 16px;">
            <label style="margin-right: 8px;">預設業主：</label>
            <nz-select [ngModel]="defaultClient()" (ngModelChange)="setDefaultClient($event)" style="width: 200px;"
              nzPlaceHolder="請選擇預設業主">
              <nz-option *ngFor="let client of clients()" [nzValue]="client" [nzLabel]="client">
              </nz-option>
            </nz-select>
          </div>
        </div>

        <nz-table #clientTable [nzData]="clients()" nzSize="small" [nzShowPagination]="false">
          <thead>
            <tr>
              <th>業主名稱</th>
              <th>狀態</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let client of clients()">
              <td>{{ client }}</td>
              <td>
                <nz-tag [nzColor]="client === defaultClient() ? 'blue' : 'default'">
                  {{ client === defaultClient() ? '預設' : '一般' }}
                </nz-tag>
              </td>
              <td>
                <button nz-button nzType="link" nzSize="small" (click)="setDefaultClient(client)"
                  [disabled]="client === defaultClient()">
                  設為預設
                </button>
                <nz-popconfirm nzTitle="確定要刪除此業主嗎？" (nzOnConfirm)="removeClient(client)">
                  <button nz-button nzType="link" nzSize="small" nzDanger nz-popconfirm>
                    刪除
                  </button>
                </nz-popconfirm>
              </td>
            </tr>
          </tbody>
        </nz-table>
      </nz-card>
    </nz-tab>

    <!-- 工作流程模板管理 -->
    <nz-tab nzTitle="流程模板">
      <nz-card nzTitle="工作流程模板管理">
        <div style="margin-bottom: 16px;">
          <button nz-button nzType="primary" (click)="showCreateWorkflowForm()" [disabled]="!hasClients()">
            <span nz-icon nzType="plus"></span>
            新增流程模板
          </button>
          <div *ngIf="!hasClients()" style="margin-top: 8px;">
            <nz-alert nzType="warning" nzMessage="請先在業主管理中添加業主，才能創建流程模板" nzShowIcon>
            </nz-alert>
          </div>
        </div>

        <nz-table #workflowTable [nzData]="workflows()" [nzLoading]="isLoading()" nzSize="middle">
          <thead>
            <tr>
              <th>模板名稱</th>
              <th>對應業主</th>
              <th>步驟數量</th>
              <th>狀態</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let workflow of workflows()">
              <td>{{ workflow.name }}</td>
              <td>
                <nz-tag nzColor="blue">{{ workflow.clientId }}</nz-tag>
              </td>
              <td>{{ workflow.steps.length }} 步驟</td>
              <td>
                <nz-switch [ngModel]="workflow.isActive" (ngModelChange)="toggleWorkflowStatus(workflow.key!, $event)">
                </nz-switch>
              </td>
              <td>
                <button nz-button nzType="link" nzSize="small" (click)="editWorkflow(workflow)">
                  編輯
                </button>
                <nz-popconfirm nzTitle="確定要刪除此流程模板嗎？" nzOkText="確定" nzCancelText="取消"
                  (nzOnConfirm)="deleteWorkflow(workflow.key!)">
                  <button nz-button nzType="link" nzSize="small" nzDanger nz-popconfirm>
                    刪除
                  </button>
                </nz-popconfirm>
              </td>
            </tr>
          </tbody>
        </nz-table>
      </nz-card>
    </nz-tab>

    <!-- 流程模板編輯 -->
    <nz-tab nzTitle="編輯模板" [nzDisabled]="!showWorkflowForm()">
      <nz-card [nzTitle]="editingWorkflow() ? '編輯流程模板' : '新增流程模板'" *ngIf="showWorkflowForm()">
        <form nz-form [formGroup]="workflowForm" (ngSubmit)="onSubmitWorkflow()">
          <nz-form-item>
            <nz-form-label [nzSpan]="6" nzRequired>模板名稱</nz-form-label>
            <nz-form-control [nzSpan]="18" nzErrorTip="請輸入模板名稱">
              <input nz-input formControlName="name" placeholder="請輸入流程模板名稱" />
            </nz-form-control>
          </nz-form-item>

          <nz-form-item>
            <nz-form-label [nzSpan]="6" nzRequired>對應業主</nz-form-label>
            <nz-form-control [nzSpan]="18" nzErrorTip="請選擇業主">
              <nz-select formControlName="clientId" nzPlaceHolder="請選擇業主">
                <nz-option *ngFor="let client of availableClients()" [nzValue]="client" [nzLabel]="client">
                </nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>

          <nz-form-item>
            <nz-form-label [nzSpan]="6">審批步驟</nz-form-label>
            <nz-form-control [nzSpan]="18">
              <div formArrayName="steps">
                <nz-card *ngFor="let step of stepsFormArray.controls; let i = index" [formGroupName]="i"
                  [nzTitle]="'步驟 ' + (i + 1)" nzSize="small" style="margin-bottom: 16px;" [nzExtra]="stepExtra">

                  <ng-template #stepExtra>
                    <button nz-button nzType="text" nzDanger nzSize="small" type="button" (click)="removeStep(i)"
                      *ngIf="stepsFormArray.length > 1">
                      <span nz-icon nzType="delete"></span>
                    </button>
                  </ng-template>

                  <nz-form-item>
                    <nz-form-label [nzSpan]="8" nzRequired>步驟名稱</nz-form-label>
                    <nz-form-control [nzSpan]="16" nzErrorTip="請輸入步驟名稱">
                      <input nz-input formControlName="name" placeholder="請輸入步驟名稱" />
                    </nz-form-control>
                  </nz-form-item>

                  <nz-form-item>
                    <nz-form-label [nzSpan]="8" nzRequired>審批人</nz-form-label>
                    <nz-form-control [nzSpan]="16" nzErrorTip="請輸入審批人">
                      <input nz-input formControlName="approver" placeholder="請輸入審批人" />
                    </nz-form-control>
                  </nz-form-item>
                </nz-card>
              </div>

              <button nz-button nzType="dashed" type="button" (click)="addStep()" style="width: 100%; margin-top: 8px;">
                <span nz-icon nzType="plus"></span>
                添加步驟
              </button>
            </nz-form-control>
          </nz-form-item>

          <nz-form-item>
            <nz-form-control [nzOffset]="6" [nzSpan]="18">
              <button nz-button nzType="primary" [nzLoading]="isSubmitting()" [disabled]="!workflowForm.valid"
                type="submit">
                {{ editingWorkflow() ? '更新' : '創建' }}模板
              </button>
              <button nz-button type="button" (click)="cancelWorkflowEdit()" style="margin-left: 8px;">
                取消
              </button>
            </nz-form-control>
          </nz-form-item>
        </form>
      </nz-card>
    </nz-tab>
  </nz-tabset>
</div>