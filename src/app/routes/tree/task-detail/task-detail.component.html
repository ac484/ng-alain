<div class="task-detail-container">
  <ng-container *ngIf="loading">
    <div class="loading-container">
      <nz-spin nzTip="載入中..."></nz-spin>
    </div>
  </ng-container>

  <ng-container *ngIf="!loading">
    <ng-container *ngIf="task$ | async as task; else noTask">
      <!-- 頂部導航 -->
      <div class="task-nav">
        <button nz-button nzType="text" (click)="goBack()">
          <span nz-icon nzType="arrow-left"></span>
          返回
        </button>
      </div>

      <!-- 任務標題與狀態 -->
      <div class="task-header">
        <h1>{{ task.title }}</h1>
        <nz-tag [nzColor]="statusColors[task.taskStatus || 'pending']">
          {{ task.taskStatus || '待辦' }}
        </nz-tag>
      </div>

      <!-- 任務內容 -->
      <div *ngIf="!editMode" class="task-content">
        <!-- 任務描述 -->
        <div class="task-section">
          <div class="section-title">描述</div>
          <div class="section-content">
            {{ task.description || '無描述' }}
          </div>
        </div>

        <!-- 任務詳情 -->
        <div class="task-section">
          <div class="section-title">詳情</div>
          <div class="info-grid">
            <div class="info-item">
              <div class="info-label">創建時間</div>
              <div class="info-value">{{ formatDate(task.createdAt) }}</div>
            </div>
            <div class="info-item">
              <div class="info-label">更新時間</div>
              <div class="info-value">{{ formatDate(task.updatedAt) }}</div>
            </div>
            <div class="info-item" *ngIf="task.createdBy">
              <div class="info-label">創建者</div>
              <div class="info-value">{{ task.createdBy }}</div>
            </div>
            <div class="info-item" *ngIf="task.type">
              <div class="info-label">類型</div>
              <div class="info-value">{{ task.type }}</div>
            </div>
          </div>
        </div>

        <!-- 任務操作 -->
        <div class="task-actions">
          <button nz-button nzType="default" (click)="toggleEditMode()">編輯</button>

          <div class="status-buttons">
            <button nz-button [class.active]="task.taskStatus === 'pending'" (click)="updateTaskStatus('pending')">待辦</button>
            <button nz-button [class.active]="task.taskStatus === 'in-progress'" (click)="updateTaskStatus('in-progress')">進行中</button>
            <button nz-button [class.active]="task.taskStatus === 'completed'" (click)="updateTaskStatus('completed')">已完成</button>
            <button nz-button [class.active]="task.taskStatus === 'cancelled'" (click)="updateTaskStatus('cancelled')">已取消</button>
          </div>
        </div>
      </div>

      <!-- 編輯模式 -->
      <div *ngIf="editMode" class="task-edit">
        <div class="form-group">
          <label>狀態</label>
          <select [(ngModel)]="taskStatus" name="taskStatus">
            <option value="pending">待辦</option>
            <option value="in-progress">進行中</option>
            <option value="completed">已完成</option>
            <option value="cancelled">已取消</option>
          </select>
        </div>

        <div class="form-actions">
          <button nz-button nzType="primary" (click)="saveChanges(task)">保存</button>
          <button nz-button nzType="default" (click)="toggleEditMode()">取消</button>
        </div>
      </div>
    </ng-container>

    <ng-template #noTask>
      <div class="empty-state">
        <nz-empty nzDescription="找不到任務詳情"></nz-empty>
        <button nz-button nzType="primary" (click)="goBack()">返回任務列表</button>
      </div>
    </ng-template>
  </ng-container>
</div>
