import{B as v,C as A,I as u,K as n,N as g,O as m,T as b,U as h,X as x,Y as L,o as j,r as O}from"./chunk-THLQETHC.js";import{g as P}from"./chunk-SB2HO6JZ.js";import{B as a,fa as R,h as U,ma as f,ra as d,u as o,v as C}from"./chunk-W6OF5JYC.js";import{a as p,b as y}from"./chunk-57BLH6QZ.js";var l=class l{constructor(){this.firestore=d(A)}saveUser(e,r){let i=n(this.firestore,"acl_users",e.uid),t=v(),s={uid:e.uid,email:e.email,displayName:e.displayName,photoURL:e.photoURL,emailVerified:e.emailVerified,roles:["user"],permissions:["dashboard"],lastLoginAt:t,updatedAt:t,loginMethod:r,isActive:!0};return o(h(i,s,{merge:!0}))}getUserProfile(e){let r=n(this.firestore,"acl_users",e);return o(g(r)).pipe(a(i=>{if(i.exists()){let t=i.data();return{uid:t.uid,email:t.email,displayName:t.displayName,photoURL:t.photoURL,emailVerified:t.emailVerified,role:t.roles?.[0]||"user",permissions:t.permissions||["dashboard"],createdAt:t.createdAt,updatedAt:t.updatedAt,lastLoginAt:t.lastLoginAt,loginMethod:t.loginMethod,isActive:t.isActive}}return null}))}getAllUsers(){let e=u(this.firestore,"acl_users");return o(m(e)).pipe(a(r=>{let i=[];return r.forEach(t=>{let s=t.data();i.push({uid:s.uid,email:s.email,displayName:s.displayName,photoURL:s.photoURL,emailVerified:s.emailVerified,role:s.roles?.[0]||"user",permissions:s.permissions||["dashboard"],createdAt:s.createdAt,updatedAt:s.updatedAt,lastLoginAt:s.lastLoginAt,loginMethod:s.loginMethod,isActive:s.isActive})}),i}))}updateUserProfile(e,r){let i=n(this.firestore,"acl_users",e),t=y(p({},r),{updatedAt:v()});return o(x(i,t))}};l.\u0275fac=function(r){return new(r||l)},l.\u0275prov=f({token:l,factory:l.\u0275fac,providedIn:"root"});var S=l;var c=class c{constructor(){this.firestore=d(A);this.auth=d(j);this.aclSrv=d(P);this.userACLSubject=new U(null);this.userACL$=this.userACLSubject.asObservable();O(this.auth).pipe(R(e=>e?this.loadUserACL(e.uid):C(null))).subscribe(e=>{this.userACLSubject.next(e),e?this.applyACL(e):this.clearACL()})}loadUserACL(e){let r=n(this.firestore,"acl_users",e);return o(g(r)).pipe(a(i=>i.exists()?i.data():null))}applyACL(e){this.aclSrv.set({role:e.roles,ability:e.permissions})}clearACL(){this.aclSrv.setFull(!1),this.aclSrv.set({role:[],ability:[]})}getRoles(){let e=u(this.firestore,"acl_roles"),r=b(e,L("isActive","==",!0));return o(m(r)).pipe(a(i=>i.docs.map(t=>p({id:t.id},t.data()))))}getPermissions(){let e=u(this.firestore,"acl_permissions"),r=b(e,L("isActive","==",!0));return o(m(r)).pipe(a(i=>i.docs.map(t=>p({id:t.id},t.data()))))}updateUserACL(e,r,i){let t=n(this.firestore,"acl_users",e),s={uid:e,roles:r,permissions:i,isActive:!0,updatedAt:new Date};return o(h(t,s,{merge:!0})).pipe(a(()=>{e===this.auth.currentUser?.uid&&(this.applyACL(s),this.userACLSubject.next(s))}))}can(e){return this.aclSrv.can(e)}hasRole(e){return this.aclSrv.can(e)}get data(){return this.aclSrv.data}};c.\u0275fac=function(r){return new(r||c)},c.\u0275prov=f({token:c,factory:c.\u0275fac,providedIn:"root"});var D=c;export{S as a,D as b};
