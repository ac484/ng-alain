---
alwaysApply: false
---
## 二、查詢流程

```mermaid
flowchart TD
    QStart[查詢請求] --> QVec[Redis 向量搜尋]
    QVec -- 高相關 --> QUse[直接回傳]
    QVec -- 低相關/未命中 --> QFlow[查 Memory-Flow]
    QFlow -- 命中 --> QAcc[積累到 Redis]
    QFlow -- 未命中 --> QBank[查 Memory-Bank]
    QBank -- 命中 --> QAcc2[積累到 Redis]
    QBank -- 未命中 --> QCtx7[查 Context7]
    QCtx7 -- 命中 --> QAcc3[積累到 Redis]
    QCtx7 -- 未命中 --> QNotFound[回傳未找到]
    QAcc --> QUse
    QAcc2 --> QUse
    QAcc3 --> QUse
```

- 查詢時，先用向量搜尋（vector_search_hash），相關度高才直接回傳。
- 若未命中或相關度低，依序 fallback 至 Memory-Flow、Memory-Bank、Context7。
- 查到高質量新知識時，積累回 Redis 並存向量。

---

## 三、積累/寫入規則

- 僅高質量知識（如人工審核、質量分數高、查詢高頻）才寫入 Redis。
- 寫入時自動生成向量 embedding，並存入 `knowledge_vectors`。
- 若已存在同 id，則進行「覆蓋」或「版本升級」。

---

## 四、更新/覆蓋規則

- Memory-Bank/Flow 有新決策時，主動同步到 Redis。
- 若知識內容有變更，則覆蓋原有資料（保留 version 與 updated_at）。
- 新知識明顯優於舊資料時，直接覆蓋（依質量分數、人工審核）。

---

## 五、刪除/淘汰規則

- 定期（或根據事件）清理過期、低質量、重複資料。
- 支援 TTL（自動過期）、人工標記刪除、查詢頻率低自動淘汰。
- 刪除時同步移除向量索引。

---

## 六、AI 決策邏輯

| 行為   | 觸發條件                                                                 |
|--------|--------------------------------------------------------------------------|
| 查詢   | 任何知識請求，先查 Redis 向量庫                                          |
| 寫入   | Memory-Flow/Bank/Context7 查到高質量新知識，或查詢高頻自動積累           |
| 更新   | Memory-Flow/Bank 有新決策、知識內容有變更                                |
| 刪除   | 資料過期、低質量、重複、查詢頻率低、人工標記                             |
| 覆蓋   | 新知識明顯優於舊資料（質量分數高、內容更完整、人工審核）                 |

---

## 七、維護與審查

- 每週自動統計 Redis 命中率、資料質量分布、查詢頻率。
- 低質量/過期/冷門資料自動淘汰。
- Memory-Bank/Flow 重大更新時，主動同步 Redis。
- 定期人工審查高頻知識，確保知識庫質量。

---

## 八、實作建議

- 查詢、積累、淘汰、覆蓋流程自動化，減少人工干預。
- 所有寫入/覆蓋/刪除操作有日誌可追溯。
- Redis 只做快取與高頻知識庫，長期決策仍以 Memory-Bank/Flow 為主。

---

## 智能積累與自淨流程

```mermaid
flowchart TD
    N[新知識產生] --> Q[質量評分/審核]
    Q -- 高質量 --> V[生成向量/存入 Redis]
    Q -- 低質量 --> D[丟棄/不積累]
    V --> F{已存在同 id?}
    F -- 是 --> U[覆蓋/版本升級]
    F -- 否 --> S[新增]
    S & U --> L[記錄日誌]
    L --> R[定期清理/淘汰]
    R -->|過期/低質量/冷門| X[刪除]
    R -->|高頻/高質量| K[保留/升級]
```

### 流程說明
1. **新知識產生**：來自 context7、memory-flow、memory-bank 或用戶輸入。
2. **質量評分/審核**：自動或人工評分，僅高質量（如分數 > 0.8）才進入 Redis。
3. **生成向量/存入 Redis**：自動生成 embedding，存入 knowledge_vectors。
4. **覆蓋/版本升級**：若已存在同 id，且新知識明顯優於舊資料，則覆蓋並升級 version。
5. **記錄日誌**：所有寫入/覆蓋/刪除皆記錄日誌，便於追溯。
6. **定期清理/淘汰**：定期（或事件觸發）清理過期、低質量、冷門資料。
7. **刪除/保留**：過期、低質量、查詢頻率低自動刪除；高頻/高質量則保留或升級。

### 規則建議
- **積累門檻**：質量分數 > 0.8 才積累。
- **淘汰門檻**：TTL（如 30 天）、查詢頻率低於 2 次/30 天自動淘汰。
- **覆蓋規則**：新知識內容明顯優於舊資料時直接覆蓋，保留 version 與 updated_at。
- **人工審查**：每週統計命中率、質量分布、查詢頻率，低質量/冷門自動淘汰。
- **日誌追蹤**：所有操作皆記錄日誌，便於審查。

### 偽代碼範例
```typescript
function accumulateToRedis(knowledge) {
  if (qualityScore(knowledge) < 0.8) return; // 低質量不積累
  const id = getKnowledgeId(knowledge);
  if (redis.exists(id)) {
    if (isBetter(knowledge, redis.get(id))) {
      redis.set(id, knowledge, { version: nextVersion(), updated_at: now() });
      log('覆蓋', id);
    }
  } else {
    redis.set(id, knowledge, { version: 1, created_at: now() });
    log('新增', id);
  }
}

function periodicCleanup() {
  for (const id of redis.keys()) {
    if (isExpired(id) || isLowQuality(id) || isLowFrequency(id)) {
      redis.delete(id);
      log('刪除', id);
    }
  }
}
```

---

> 本規範為 MCP Redis 向量知識庫最佳實踐，請團隊嚴格遵循，並根據實際需求持續優化。


[[calls]]
match = """redis|cache|store|save|get|retrieve|set|hash|list|stream|json|pub|sub|zadd|sadd|lpush|rpush|hset|hget|vector|search|memory|session|queue"""
tool = "redis-mcp"

match = """redis|cache|store|save|get|retrieve|set|hash|list|stream|json|pub|sub|zadd|sadd|lpush|rpush|hset|hget|vector|search|memory|session|queue"""
tool = "redis-mcp"
